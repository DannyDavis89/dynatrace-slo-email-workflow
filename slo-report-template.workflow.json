{
  "id": "889b61ba-32a1-40e7-b6f3-b649ce67217c",
  "title": "SLO Report - Template",
  "description": "",
  "actor": "b85f9ad1-dddd-4ad5-920d-ac7d4f6bd89f",
  "owner": "b85f9ad1-dddd-4ad5-920d-ac7d4f6bd89f",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 1000,
  "guide": null,
  "tasks": {
    "send_email_1": {
      "name": "send_email_1",
      "input": {
        "cc": [],
        "to": [],
        "bcc": [],
        "content": "{{ result('build_markdown_email').markdown }}",
        "subject": "[EXT] SLO Report - Your Domain Name - {{ result('build_markdown_email').reportDate }}"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "states": {
          "build_markdown_email": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "build_markdown_email"
      ]
    },
    "fetch_slo_data": {
      "name": "fetch_slo_data",
      "input": {
        "script": "// ============================================\n// 1_fetch_slo_data.js\n// SLO Data Fetcher - Collects SLO status, user action\n// metrics, entity IDs, and synthetic availability data.\n//\n// This is the first task in the workflow. It gathers all\n// data needed by the build_markdown_email task.\n//\n// SDK Clients Used:\n//   - serviceLevelObjectivesClient: SLO status and targets\n//   - rumUserSessionsClient: USQL queries for user action metrics\n//   - monitoredEntitiesClient: Entity ID lookups for deep links\n//   - metricsClient: Synthetic monitor availability\n// ============================================\n\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { serviceLevelObjectivesClient } from '@dynatrace-sdk/client-classic-environment-v2';\nimport { rumUserSessionsClient } from '@dynatrace-sdk/client-classic-environment-v2';\nimport { monitoredEntitiesClient } from '@dynatrace-sdk/client-classic-environment-v2';\nimport { metricsClient } from '@dynatrace-sdk/client-classic-environment-v2';\n\nexport default async function ({ execution_id }) {\n\n  // ============================================\n  // CONFIGURATION\n  // TODO: Update all values below for your domain\n  // ============================================\n\n  // TODO: Add your SLO IDs here\n  // Find these in Dynatrace: Service Level Objectives page > click SLO > ID in URL\n  const sloIds = [\n    // \"your-slo-id-1\",  // e.g., Application Apdex\n    // \"your-slo-id-2\",  // e.g., Error-Free Rate\n    // \"your-slo-id-3\",  // e.g., Key UA Performance\n  ];\n\n  // TODO: Update with your dashboard URL\n  const dashboardUrl = \"https://YOUR_TENANT.apps.dynatrace.com/ui/apps/dynatrace.classic.dashboards/#dashboard;gtf=-2h;gf=all;id=YOUR_DASHBOARD_ID\";\n\n  // TODO: Update with your Dynatrace application name (for USQL queries)\n  // This must match the application name exactly as shown in Dynatrace\n  const applicationName = \"Your Application Name\";\n\n  // TODO: Configure synthetic SLO mappings (if applicable)\n  // Map SLO IDs to their synthetic monitor details\n  // Leave empty {} if you don't use synthetic SLOs\n  const syntheticSloConfig = {\n    // \"synthetic-slo-id-1\": {\n    //   syntheticId: \"SYNTHETIC_TEST-XXXXXXXXXXXX\",\n    //   syntheticName: \"Your Monitor Name\",\n    //   type: \"BROWSER\"  // or \"HTTP\"\n    // },\n  };\n\n  // Batching configuration\n  // SLO API has a max pageSize of 25 when evaluate=true\n  const SLO_BATCH_SIZE = 20;\n  // USQL has query length limits, so batch user actions\n  const USQL_BATCH_SIZE = 10;\n\n  // ============================================\n  // HELPER FUNCTIONS\n  // ============================================\n\n  // Helper to split array into batches\n  const batchArray = (array, batchSize) => {\n    const batches = [];\n    for (let i = 0; i < array.length; i += batchSize) {\n      batches.push(array.slice(i, i + batchSize));\n    }\n    return batches;\n  };\n\n  // Helper to parse user action names from SLO filter expressions\n  const parseUserActionsFromFilter = (filter) => {\n    if (!filter) return [];\n\n    const normalizedFilter = filter.replace(/\\n/g, '').replace(/\\s+/g, ' ');\n    const userActions = [];\n\n    // Match IN() syntax: entityname.in(\"action1\",\"action2\")\n    const inMatch = normalizedFilter.match(/entityname\\.in\\s*\\(\\s*([^)]+)\\)/i);\n    if (inMatch) {\n      const quotedStrings = inMatch[1].match(/\"([^\"]+)\"/g);\n      if (quotedStrings) {\n        for (const qs of quotedStrings) {\n          const action = qs.replace(/^\"|\"$/g, '');\n          if (action && action.trim()) {\n            userActions.push(action.trim());\n          }\n        }\n      }\n    }\n\n    // Match equals() syntax: entityname.equals(\"action\")\n    const equalsMatch = normalizedFilter.match(/entityname\\.equals\\s*\\(\\s*\"([^\"]+)\"\\s*\\)/i);\n    if (equalsMatch) {\n      userActions.push(equalsMatch[1].trim());\n    }\n\n    // Match contains() syntax: entityname.contains(\"action\")\n    const containsMatch = normalizedFilter.match(/entityname\\.contains\\s*\\(\\s*\"([^\"]+)\"\\s*\\)/i);\n    if (containsMatch) {\n      userActions.push(containsMatch[1].trim());\n    }\n\n    return userActions;\n  };\n\n  // Helper to check if an SLO is synthetic-based\n  const isSyntheticSlo = (sloId) => {\n    return syntheticSloConfig.hasOwnProperty(sloId);\n  };\n\n  // ============================================\n  // BATCHING SETUP\n  // ============================================\n  const sloBatches = batchArray(sloIds, SLO_BATCH_SIZE);\n  console.log(\"Split \" + sloIds.length + \" SLOs into \" + sloBatches.length + \" batches\");\n\n  // ============================================\n  // TIME PERIODS\n  // These define the evaluation windows for SLO data\n  // ============================================\n  const timePeriods = [\n    { name: \"day90\", from: \"now-90d\", to: \"now\" },\n    { name: \"day30\", from: \"now-30d\", to: \"now\" },\n    { name: \"day7\", from: \"now-7d\", to: \"now\" },\n    { name: \"current\", from: \"now-1d\", to: \"now\" }\n  ];\n\n  // ============================================\n  // FETCH SLO DATA (WITH BATCHING)\n  // Fetches each SLO at each time period\n  // ============================================\n  const results = {};\n\n  for (const period of timePeriods) {\n    results[period.name] = [];\n\n    for (let batchIndex = 0; batchIndex < sloBatches.length; batchIndex++) {\n      const batch = sloBatches[batchIndex];\n      const batchSelector = 'id(\"' + batch.join('\",\"') + '\")';\n\n      try {\n        const data = await serviceLevelObjectivesClient.getSlo({\n          sloSelector: batchSelector,\n          timeFrame: \"GTF\",\n          from: period.from,\n          to: period.to,\n          pageSize: SLO_BATCH_SIZE,\n          evaluate: true\n        });\n\n        const batchResults = data.slo || [];\n        results[period.name] = results[period.name].concat(batchResults);\n\n        console.log(\"Fetched batch \" + (batchIndex + 1) + \"/\" + sloBatches.length + \" for \" + period.name + \": \" + batchResults.length + \" SLOs\");\n      } catch (error) {\n        console.error(\"Error fetching \" + period.name + \" batch \" + (batchIndex + 1) + \": \" + error.message);\n      }\n    }\n\n    console.log(\"Total \" + period.name + \": \" + results[period.name].length + \" SLOs\");\n  }\n\n  // ============================================\n  // BUILD SLO REPORT\n  // Combine all time periods into a single object per SLO\n  // ============================================\n  const sloReport = sloIds.map(id => {\n    const slo90 = results.day90.find(s => s.id === id);\n    const slo30 = results.day30.find(s => s.id === id);\n    const slo7 = results.day7.find(s => s.id === id);\n    const sloCurrent = results.current.find(s => s.id === id);\n\n    // Use the most recent data for base info (name, target, filter)\n    const baseSlo = sloCurrent || slo7 || slo30 || slo90;\n\n    // Parse user actions from the SLO's metric expression filter\n    const userActions = baseSlo ? parseUserActionsFromFilter(baseSlo.metricExpression) : [];\n\n    // Check if this is a synthetic SLO\n    const synthetic = isSyntheticSlo(id);\n\n    return {\n      id: id,\n      name: baseSlo ? baseSlo.name : \"Unknown SLO\",\n      target: baseSlo ? (baseSlo.target || 0) : 0,\n      day90: slo90 ? { status: slo90.evaluatedPercentage, errorBudget: slo90.errorBudget } : null,\n      day30: slo30 ? { status: slo30.evaluatedPercentage, errorBudget: slo30.errorBudget } : null,\n      day7: slo7 ? { status: slo7.evaluatedPercentage, errorBudget: slo7.errorBudget } : null,\n      current: sloCurrent ? { status: sloCurrent.evaluatedPercentage, errorBudget: sloCurrent.errorBudget } : null,\n      userAction: userActions,\n      isSynthetic: synthetic,\n      syntheticConfig: synthetic ? syntheticSloConfig[id] : null\n    };\n  });\n\n  console.log(\"Built report for \" + sloReport.length + \" SLOs\");\n\n  // ============================================\n  // FETCH USER ACTION METRICS (USQL)\n  // Queries completed user sessions for error counts\n  // and average duration per user action\n  // ============================================\n  const allUserActions = [];\n  for (const slo of sloReport) {\n    if (!slo.isSynthetic && slo.userAction && slo.userAction.length > 0) {\n      for (const ua of slo.userAction) {\n        if (!allUserActions.includes(ua)) {\n          allUserActions.push(ua);\n        }\n      }\n    }\n  }\n\n  console.log(\"Total unique user actions to query: \" + allUserActions.length);\n\n  const userActionMetrics = {};\n\n  if (allUserActions.length > 0) {\n    const uaBatches = batchArray(allUserActions, USQL_BATCH_SIZE);\n    console.log(\"Split \" + allUserActions.length + \" user actions into \" + uaBatches.length + \" USQL batches\");\n\n    for (let batchIndex = 0; batchIndex < uaBatches.length; batchIndex++) {\n      const batch = uaBatches[batchIndex];\n\n      // Build the IN() clause for this batch\n      const inClause = batch.map(ua => '\"' + ua.replace(/\"/g, '\\\\\"') + '\"').join(', ');\n\n      const query = 'SELECT name, ' +\n        'AVG(duration) AS avg_duration, ' +\n        'SUM(customErrorCount) AS total_customErrors, ' +\n        'SUM(javascriptErrorCount) AS total_jsErrors, ' +\n        'SUM(requestErrorCount) AS total_requestErrors ' +\n        'FROM useraction ' +\n        'WHERE application = \"' + applicationName + '\" ' +\n        'AND name IN (' + inClause + ') ' +\n        'GROUP BY name';\n\n      try {\n        const response = await rumUserSessionsClient.getUsqlResultAsTable({\n          query: query,\n          startTimestamp: Date.now() - (7 * 24 * 60 * 60 * 1000),\n          endTimestamp: Date.now()\n        });\n\n        if (response.values) {\n          for (const row of response.values) {\n            const actionName = row[0];\n            userActionMetrics[actionName] = {\n              avgDuration: row[1] || 0,\n              customErrors: row[2] || 0,\n              jsErrors: row[3] || 0,\n              requestErrors: row[4] || 0\n            };\n          }\n        }\n\n        console.log(\"USQL batch \" + (batchIndex + 1) + \"/\" + uaBatches.length + \": \" + (response.values ? response.values.length : 0) + \" results\");\n      } catch (error) {\n        console.error(\"USQL batch \" + (batchIndex + 1) + \" error: \" + error.message);\n      }\n    }\n  }\n\n  // ============================================\n  // FETCH USER ACTION ENTITY IDs (FOR DEEP LINKS)\n  // Looks up entity IDs so we can build clickable URLs\n  // Note: User actions must be marked as \"Key User Actions\"\n  // in Dynatrace to receive entity IDs\n  // ============================================\n  const userActionEntities = {};\n\n  for (const ua of allUserActions) {\n    try {\n      const response = await monitoredEntitiesClient.getEntities({\n        entitySelector: 'type(\"KEY_USER_ACTION\"),entityName(\"' + ua + '\")',\n        fields: '+fromRelationships',\n        pageSize: 1\n      });\n\n      if (response.entities && response.entities.length > 0) {\n        const entity = response.entities[0];\n        let applicationId = null;\n\n        // Get the parent application ID from relationships\n        if (entity.fromRelationships && entity.fromRelationships.isActionOf) {\n          for (const rel of entity.fromRelationships.isActionOf) {\n            if (rel.id && rel.id.startsWith(\"APPLICATION-\")) {\n              applicationId = rel.id;\n              break;\n            }\n          }\n        }\n\n        userActionEntities[ua] = {\n          entityId: entity.entityId,\n          applicationId: applicationId\n        };\n      }\n    } catch (error) {\n      // Entity not found - user action may not be a Key User Action\n      console.log(\"No entity found for: \" + ua.substring(0, 50) + \"...\");\n    }\n  }\n\n  console.log(\"Found entities for \" + Object.keys(userActionEntities).length + \"/\" + allUserActions.length + \" user actions\");\n\n  // ============================================\n  // FETCH SYNTHETIC AVAILABILITY (IF APPLICABLE)\n  // Queries the metrics API for synthetic monitor\n  // availability over the last 7 days\n  // ============================================\n  const syntheticMetrics = {};\n\n  for (const [sloId, config] of Object.entries(syntheticSloConfig)) {\n    try {\n      const metricSelector = 'builtin:synthetic.browser.availability.location.total:filter(eq(\"dt.entity.synthetic_test\",\"' + config.syntheticId + '\")):avg';\n\n      const response = await metricsClient.query({\n        metricSelector: metricSelector,\n        from: \"now-7d\",\n        to: \"now\",\n        resolution: \"Inf\"\n      });\n\n      if (response.result && response.result.length > 0) {\n        const metric = response.result[0];\n        if (metric.data && metric.data.length > 0) {\n          const dataPoint = metric.data[0];\n          const values = dataPoint.values || [];\n          const validValues = values.filter(v => v != null);\n\n          if (validValues.length > 0) {\n            const avgAvailability = validValues.reduce((a, b) => a + b, 0) / validValues.length;\n            syntheticMetrics[config.syntheticId] = {\n              avgAvailability: avgAvailability,\n              locationCount: validValues.length\n            };\n          }\n        }\n      }\n\n      console.log(\"Synthetic \" + config.syntheticName + \": \" + (syntheticMetrics[config.syntheticId] ? syntheticMetrics[config.syntheticId].avgAvailability.toFixed(2) + \"%\" : \"no data\"));\n    } catch (error) {\n      console.error(\"Error fetching synthetic data for \" + config.syntheticName + \": \" + error.message);\n    }\n  }\n\n  // ============================================\n  // BUILD REPORT DATE\n  // ============================================\n  const now = new Date();\n  const reportDate = now.toLocaleDateString('en-US', {\n    weekday: 'long',\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric'\n  });\n\n  // ============================================\n  // DETERMINE BREACH STATUS\n  // Used by create_ado_ticket task condition\n  // ============================================\n  const hasBreach = sloReport.some(slo => {\n    const day7Status = slo.day7 ? slo.day7.status : null;\n    return day7Status != null && day7Status >= 0 && day7Status < slo.target;\n  });\n\n  // ============================================\n  // RETURN ALL DATA\n  // ============================================\n  const output = {\n    slos: sloReport,\n    userActionMetrics: userActionMetrics,\n    userActionEntities: userActionEntities,\n    syntheticMetrics: syntheticMetrics,\n    reportDate: reportDate,\n    dashboardUrl: dashboardUrl,\n    hasBreach: hasBreach\n  };\n\n  console.log(\"=== FETCH COMPLETE ===\");\n  console.log(\"SLOs: \" + output.slos.length);\n  console.log(\"User Action Metrics: \" + Object.keys(output.userActionMetrics).length);\n  console.log(\"User Action Entities: \" + Object.keys(output.userActionEntities).length);\n  console.log(\"Synthetic Metrics: \" + Object.keys(output.syntheticMetrics).length);\n  console.log(\"Has Breach: \" + output.hasBreach);\n\n  return output;\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 1
      },
      "description": "Run custom JavaScript code.",
      "predecessors": []
    },
    "create_ado_ticket": {
      "name": "create_ado_ticket",
      "input": {
        "script": "// ============================================\n// 2_build_markdown_email.js\n// SLO Email Report Builder - Markdown Generator\n//\n// This task transforms raw SLO data into a formatted\n// markdown email report with trend analysis, user action\n// metrics, and optional synthetic monitoring details.\n//\n// Prerequisites: Must run after fetch_slo_data task\n// ============================================\n\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nexport default async function ({ execution_id }) {\n  const ex = await execution(execution_id);\n  const sloData = await ex.result('fetch_slo_data');\n\n  console.log(\"=== BUILD MARKDOWN EMAIL ===\");\n  console.log(\"Number of SLOs received: \" + sloData.slos.length);\n  console.log(\"User action metrics received: \" + Object.keys(sloData.userActionMetrics || {}).length);\n  console.log(\"User action entities received: \" + Object.keys(sloData.userActionEntities || {}).length);\n  console.log(\"Synthetic metrics received: \" + Object.keys(sloData.syntheticMetrics || {}).length);\n\n  // ============================================\n  // CONFIGURATION\n  // TODO: Update these values for your domain\n  // ============================================\n\n  // TODO: Update report title and subtitle\n  const reportTitle = \"\ud83d\udcca SLO Report\";\n  const reportSubtitle = \"Your Domain Name (Prod)\"; // e.g., \"Financial Picture (Prod)\", \"Collaboration (Prod)\"\n\n  // TODO: Update dashboard URLs for your environment\n  const sloExplainedUrl = \"https://YOUR_TENANT.apps.dynatrace.com/ui/apps/dynatrace.classic.dashboards/#dashboard;gtf=-1w;gf=all;id=YOUR_DASHBOARD_ID\";\n  const errorAnalysisUrl = \"\"; // Optional: URL to an error analysis dashboard\n\n  // TODO: Update your Dynatrace tenant URL (used for deep links)\n  const dynatraceTenantUrl = \"https://YOUR_TENANT.apps.dynatrace.com\";\n\n  // TODO: If you have priority SLOs that should appear at the top of each category, list their IDs here\n  // These are typically application-level SLOs (e.g., Application Apdex, Error-Free Rate)\n  // Leave empty [] if you don't need priority ordering\n  const prioritySloIds = [\n    // \"your-priority-slo-id-1\", // e.g., Application Apdex\n    // \"your-priority-slo-id-2\", // e.g., All User Action Error-Free Rate\n  ];\n\n  // Synthetic availability threshold (only show if below this)\n  // TODO: Adjust if your synthetic SLOs have different targets\n  const SYNTHETIC_AVAILABILITY_THRESHOLD = 99.98;\n\n  // ============================================\n  // HELPER FUNCTIONS\n  // These generally don't need modification\n  // ============================================\n\n  // Helper to safely get nested property\n  const safeGet = (obj, prop) => obj && obj[prop] !== undefined ? obj[prop] : null;\n\n  // Helper to check if status is valid\n  const isValidStatus = (val) => val != null && val !== undefined && val >= 0;\n\n  // Helper to format status value\n  const fmtStatus = (val) => {\n    if (!isValidStatus(val)) return \"N/A\";\n    return val.toFixed(2) + \"%\";\n  };\n\n  // Helper to get status emoji based on value vs target\n  const getStatusEmoji = (val, target) => {\n    if (!isValidStatus(val)) return \"\u2796\";\n    if (val >= target) return \"\u2705\";\n    if (val >= target * 0.95) return \"\u26a0\ufe0f\";\n    return \"\u274c\";\n  };\n\n  // Helper to get the \"current\" period data\n  const getCurrent = (slo) => {\n    if (slo.current) return slo.current;\n    if (slo.daily) return slo.daily;\n    return { status: null, errorBudget: null };\n  };\n\n  // ============================================\n  // TREND CALCULATION\n  // Evaluates direction across all 4 time windows:\n  //   90d \u2192 30d \u2192 7d \u2192 current\n  //\n  // \ud83d\udcc8 = ALL transitions going up (consistently improving)\n  // \ud83d\udcc9 = ALL transitions going down (consistently degrading)\n  // \u27a1\ufe0f = ALL values stable (within threshold, no meaningful movement)\n  // \u3030\ufe0f = Mixed directions (fluctuating)\n  // ============================================\n  const getTrend = (slo) => {\n    const current = getCurrent(slo);\n    const values = [\n      safeGet(slo.day90, 'status'),\n      safeGet(slo.day30, 'status'),\n      safeGet(slo.day7, 'status'),\n      safeGet(current, 'status')\n    ];\n\n    // Filter to only valid values\n    const valid = values.filter(v => isValidStatus(v));\n\n    // Need at least 2 data points to determine a trend\n    if (valid.length < 2) return \"\u2796\";\n\n    // Threshold for considering two values \"the same\"\n    // Near-zero: only floating-point rounding is ignored\n    // Any real movement (even 0.01%) counts as directional\n    const STABLE_THRESHOLD = 0.005;\n\n    let ups = 0;\n    let downs = 0;\n    let flats = 0;\n\n    for (let i = 0; i < valid.length - 1; i++) {\n      const diff = valid[i + 1] - valid[i];\n\n      if (Math.abs(diff) <= STABLE_THRESHOLD) {\n        flats++;\n      } else if (diff > 0) {\n        ups++;\n      } else {\n        downs++;\n      }\n    }\n\n    const transitions = valid.length - 1;\n\n    // ALL transitions are flat = stable\n    if (flats === transitions) return \"\u27a1\ufe0f\";\n\n    // ALL non-flat transitions go up (flats are ok alongside ups)\n    if (downs === 0 && ups > 0) return \"\ud83d\udcc8\";\n\n    // ALL non-flat transitions go down (flats are ok alongside downs)\n    if (ups === 0 && downs > 0) return \"\ud83d\udcc9\";\n\n    // Mix of ups and downs = fluctuating\n    return \"\u3030\ufe0f\";\n  };\n\n  // Helper to format duration with emoji warning\n  const fmtDurationWithEmoji = (ms) => {\n    if (ms == null || ms === undefined) return \"N/A\";\n\n    let formatted;\n    if (ms < 1000) {\n      formatted = Math.round(ms) + \" ms\";\n    } else {\n      formatted = (ms / 1000).toFixed(2) + \" s\";\n    }\n\n    if (ms > 12000) {\n      return formatted + \" \u274c\";\n    } else if (ms > 3000) {\n      return formatted + \" \u26a0\ufe0f\";\n    }\n\n    return formatted;\n  };\n\n  // Helper to get error emoji based on count\n  const getErrorEmoji = (count) => {\n    if (count == null || count === 0) return \"\";\n    if (count <= 10) return \" \u26a0\ufe0f\";\n    return \" \u274c\";\n  };\n\n  // ============================================\n  // USER ACTION NAME SHORTENING\n  // TODO: Adjust the shortening logic if your user action\n  // names follow a different pattern than the default\n  // \"click [button] landing on https://...\" format\n  // ============================================\n  const shortenUserAction = (userAction) => {\n    if (!userAction) return \"N/A\";\n\n    let actionType = \"\";\n    let endpoint = \"\";\n\n    if (userAction.includes(\" landing on \")) {\n      const parts = userAction.split(\" landing on \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else if (userAction.includes(\" of page \")) {\n      const parts = userAction.split(\" of page \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else {\n      return userAction.length > 50 ? userAction.substring(0, 47) + \"...\" : userAction;\n    }\n\n    let path = endpoint.replace(/https?:\\/\\/[^\\/]+/, \"\");\n    const segments = path.split(\"/\").filter(s => s.length > 0);\n    if (segments.length > 2) {\n      endpoint = \".../\" + segments.slice(-2).join(\"/\");\n    } else if (segments.length > 0) {\n      endpoint = \".../\" + segments.join(\"/\");\n    } else {\n      endpoint = path;\n    }\n\n    return actionType + \" \u2192 \" + endpoint;\n  };\n\n  // Helper to build Dynatrace user action URL\n  const buildUserActionUrl = (userAction, entities) => {\n    if (!entities || !entities.entityId || !entities.applicationId) {\n      return null;\n    }\n\n    const encodedName = userAction\n      .replace(/ /g, '%20')\n      .replace(/:/g, ':')\n      .replace(/\\/\\//g, '%5C0%5C0')\n      .replace(/\\//g, '%5C0');\n\n    // TODO: Update the base URL to match your Dynatrace tenant\n    const baseUrl = dynatraceTenantUrl + \"/ui/apps/dynatrace.classic.frontend/#uemapplications/uemuseractionmetrics\";\n\n    return baseUrl +\n      \";uemuserActionId=\" + entities.entityId +\n      \";uaname=\" + encodedName +\n      \";uemapplicationId=\" + entities.applicationId +\n      \";gtf=-7d;gf=all\";\n  };\n\n  // Helper to build Dynatrace synthetic monitor URL\n  const buildSyntheticUrl = (syntheticId, type) => {\n    if (!syntheticId) return null;\n\n    // TODO: Update the base URL to match your Dynatrace tenant\n    const baseUrl = dynatraceTenantUrl + \"/ui/apps/dynatrace.classic.synthetic/ui\";\n\n    let monitorPath;\n    if (type === \"BROWSER\") {\n      monitorPath = \"browser-monitor\";\n    } else if (type === \"HTTP\") {\n      monitorPath = \"http-monitor\";\n    } else {\n      monitorPath = \"browser-monitor\"; // default\n    }\n\n    return baseUrl + \"/\" + monitorPath + \"/\" + syntheticId + \"?gtf=-7d&gf=all\";\n  };\n\n  // Helper to check if a user action needs attention\n  // TODO: Adjust thresholds if needed\n  //   - totalErrors >= 10: flags user actions with 10+ combined errors\n  //   - avgDuration >= 3000: flags user actions averaging 3+ seconds\n  const needsAttention = (metrics) => {\n    if (!metrics) return false;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDuration = metrics.avgDuration || 0;\n\n    return totalErrors >= 10 || avgDuration >= 3000;\n  };\n\n  // Helper to calculate attention score for ranking\n  const getAttentionScore = (metrics) => {\n    if (!metrics) return 0;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDurationSeconds = (metrics.avgDuration || 0) / 1000;\n\n    return (totalErrors * 10) + avgDurationSeconds;\n  };\n\n  // Helper to format synthetic availability with emoji\n  const fmtSyntheticAvailability = (availability, target) => {\n    if (availability == null) return \"N/A\";\n\n    const formatted = availability.toFixed(2) + \"%\";\n\n    if (availability >= target) {\n      return \"\u2705 \" + formatted;\n    } else if (availability >= target * 0.99) {\n      return \"\u26a0\ufe0f \" + formatted;\n    } else {\n      return \"\u274c \" + formatted;\n    }\n  };\n\n  // ============================================\n  // SORT HELPER: Priority SLOs first, then alphabetical\n  // Only applies if prioritySloIds is configured above\n  // ============================================\n  const sortWithPriority = (slos) => {\n    if (prioritySloIds.length === 0) return slos.sort((a, b) => a.name.localeCompare(b.name));\n\n    return slos.sort((a, b) => {\n      const aIsPriority = prioritySloIds.includes(a.id);\n      const bIsPriority = prioritySloIds.includes(b.id);\n\n      if (aIsPriority && !bIsPriority) return -1;\n      if (!aIsPriority && bIsPriority) return 1;\n\n      if (aIsPriority && bIsPriority) {\n        return prioritySloIds.indexOf(a.id) - prioritySloIds.indexOf(b.id);\n      }\n\n      return a.name.localeCompare(b.name);\n    });\n  };\n\n  // ============================================\n  // CATEGORIZE SLOs\n  // Pass/fail is based on the 7-day value\n  // This provides more stable alerting than daily fluctuations\n  // ============================================\n  const failingSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return isValidStatus(status) && status < slo.target;\n    })\n  );\n\n  const passingSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return isValidStatus(status) && status >= slo.target;\n    })\n  );\n\n  const noDataSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return !isValidStatus(status);\n    })\n  );\n\n  console.log(\"Categorized: \" + failingSLOs.length + \" failing, \" + passingSLOs.length + \" passing, \" + noDataSLOs.length + \" no data\");\n\n  const breachStatus = failingSLOs.length > 0 ? \"\u274c BREACH\" : \"\u2705 OK\";\n\n  let markdown = \"\";\n\n  // ============================================\n  // REPORT HEADER\n  // ============================================\n  markdown += \"# \" + reportTitle + \"\\n\\n\";\n  markdown += \"## \" + reportSubtitle + \"\\n\\n\";\n  markdown += \"**Report Date:** \" + sloData.reportDate + \"\\n\\n\";\n\n  markdown += \"View SLO details and contributing factors on [dashboard](\" + sloData.dashboardUrl + \")\\n\\n\";\n  markdown += \"[SLOs explained](\" + sloExplainedUrl + \")\\n\\n\";\n\n  // ============================================\n  // EXECUTIVE SUMMARY\n  // ============================================\n  markdown += \"---\\n\\n\";\n  markdown += \"## Executive Summary\\n\\n\";\n  markdown += \"| Metric | Value |\\n\";\n  markdown += \"|--------|-------|\\n\";\n  markdown += \"| **Overall Status** | \" + breachStatus + \" |\\n\";\n  markdown += \"| Total SLOs Monitored | \" + sloData.slos.length + \" |\\n\";\n  markdown += \"| Passing | \" + passingSLOs.length + \" \u2705 |\\n\";\n  markdown += \"| Failing | \" + failingSLOs.length + (failingSLOs.length > 0 ? \" \u274c\" : \"\") + \" |\\n\";\n  markdown += \"| No Data | \" + noDataSLOs.length + (noDataSLOs.length > 0 ? \" \u2796\" : \"\") + \" |\\n\";\n  markdown += \"\\n\";\n\n  // ============================================\n  // SLO TABLE BUILDER\n  // Status emoji is based on the 7-day value\n  // Optional note appears between heading and table\n  // ============================================\n  const buildSLOTable = (slos, title, note) => {\n    if (slos.length === 0) return \"\";\n\n    let table = \"---\\n\\n\";\n    table += \"## \" + title + \"\\n\\n\";\n\n    // Optional note between heading and table\n    if (note) {\n      table += \"*\" + note + \"*\\n\\n\";\n    }\n\n    table += \"| SLO Name | Target | 90 Day | 30 Day | 7 Day | Current | Trend |\\n\";\n    table += \"|----------|--------|--------|--------|-------|---------|-------|\\n\";\n\n    for (const slo of slos) {\n      const current = getCurrent(slo);\n      const currentStatus = safeGet(current, \"status\");\n      const day7Status = safeGet(slo.day7, \"status\");\n\n      // Emoji reflects 7-day status vs target\n      const emoji = getStatusEmoji(day7Status, slo.target);\n      const trend = getTrend(slo);\n\n      table += \"| \" + emoji + \" \" + slo.name +\n        \" | \" + slo.target + \"%\" +\n        \" | \" + fmtStatus(safeGet(slo.day90, \"status\")) +\n        \" | \" + fmtStatus(safeGet(slo.day30, \"status\")) +\n        \" | \" + fmtStatus(day7Status) +\n        \" | \" + fmtStatus(currentStatus) +\n        \" | \" + trend +\n        \" |\\n\";\n    }\n\n    return table + \"\\n\";\n  };\n\n  // ============================================\n  // SLO TABLES\n  // ============================================\n  if (failingSLOs.length > 0) {\n    markdown += buildSLOTable(failingSLOs, \"\u274c SLOs Below Target (Action Required)\", \"Categorization is based on the 7-day value.\");\n  }\n\n  if (passingSLOs.length > 0) {\n    markdown += buildSLOTable(passingSLOs, \"\u2705 SLOs Meeting Target\");\n  }\n\n  if (noDataSLOs.length > 0) {\n    markdown += buildSLOTable(noDataSLOs, \"\u2796 SLOs With No Data\");\n  }\n\n  // ============================================\n  // USER ACTION METRICS SECTION\n  // Shows user actions that need attention:\n  //   - 10+ total errors across all error types\n  //   - 3+ second average duration\n  // Top 3 actions per SLO, ranked by severity score\n  // ============================================\n  const userActionMetrics = sloData.userActionMetrics || {};\n  const userActionEntities = sloData.userActionEntities || {};\n\n  const slosWithActionableUserActions = sloData.slos.filter(slo => {\n    // Skip synthetic SLOs - they don't have user actions\n    if (slo.isSynthetic) return false;\n    if (!slo.userAction || slo.userAction.length === 0) return false;\n\n    return slo.userAction.some(ua => {\n      const metrics = userActionMetrics[ua];\n      return metrics && needsAttention(metrics);\n    });\n  });\n\n  if (slosWithActionableUserActions.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83d\udcca User Action Metrics (7-Day Totals)\\n\\n\";\n\n    // TODO: Add error analysis dashboard link if available\n    if (errorAnalysisUrl) {\n      markdown += \"View detailed error analysis [dashboard](\" + errorAnalysisUrl + \").\\n\\n\";\n    }\n\n    markdown += \"The following user actions need attention (\u226510 total errors OR \u22653s avg duration).\\n\\n\";\n    markdown += \"**Note:** Click on the user action names to view them in Dynatrace. Metrics below are based on completed user sessions and combine all action types (XHR, Load, or Route Change) with the same name, which may result in different averages than the Dynatrace UI where these are displayed separately.\\n\\n\";\n\n    for (const slo of slosWithActionableUserActions) {\n      const userActions = Array.isArray(slo.userAction) ? slo.userAction : [slo.userAction];\n\n      const actionsNeedingAttention = userActions.filter(ua => {\n        const metrics = userActionMetrics[ua];\n        return metrics && needsAttention(metrics);\n      });\n\n      if (actionsNeedingAttention.length === 0) continue;\n\n      // Rank by severity score and show top 3\n      const sortedActions = actionsNeedingAttention\n        .map(ua => ({ userAction: ua, metrics: userActionMetrics[ua], score: getAttentionScore(userActionMetrics[ua]) }))\n        .sort((a, b) => b.score - a.score)\n        .slice(0, 3);\n\n      markdown += \"### \" + slo.name + \"\\n\\n\";\n\n      markdown += \"| User Action | Avg Duration | Custom Errors | JS Errors | Request Errors |\\n\";\n      markdown += \"|-------------|--------------|---------------|-----------|----------------|\\n\";\n\n      for (const item of sortedActions) {\n        const metrics = item.metrics;\n\n        const displayAction = shortenUserAction(item.userAction);\n        const entityData = userActionEntities[item.userAction];\n        const actionUrl = buildUserActionUrl(item.userAction, entityData);\n        const linkedAction = actionUrl ? \"[\" + displayAction + \"](\" + actionUrl + \")\" : displayAction;\n\n        const durationDisplay = fmtDurationWithEmoji(metrics.avgDuration);\n        const custDisplay = (metrics.customErrors || 0) + getErrorEmoji(metrics.customErrors);\n        const jsDisplay = (metrics.jsErrors || 0) + getErrorEmoji(metrics.jsErrors);\n        const reqDisplay = (metrics.requestErrors || 0) + getErrorEmoji(metrics.requestErrors);\n\n        markdown += \"| \" + linkedAction + \" | \" + durationDisplay + \" | \" + custDisplay + \" | \" + jsDisplay + \" | \" + reqDisplay + \" |\\n\";\n      }\n\n      markdown += \"\\n\";\n    }\n  }\n\n  // ============================================\n  // SYNTHETIC AVAILABILITY METRICS SECTION\n  // Only included if your workflow has synthetic SLOs\n  // If you don't use synthetic monitors, this section\n  // will be automatically skipped\n  // ============================================\n  const syntheticMetrics = sloData.syntheticMetrics || {};\n  const syntheticSlos = sloData.slos.filter(slo => slo.isSynthetic);\n\n  const syntheticSlosNeedingAttention = syntheticSlos.filter(slo => {\n    const config = slo.syntheticConfig;\n    if (!config) return false;\n\n    const metrics = syntheticMetrics[config.syntheticId];\n    if (!metrics || metrics.avgAvailability == null) return false;\n\n    return metrics.avgAvailability < SYNTHETIC_AVAILABILITY_THRESHOLD;\n  });\n\n  if (syntheticSlos.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83e\udd16 Synthetic Availability Metrics (7-Day Totals)\\n\\n\";\n    markdown += \"The following SLOs use Synthetic Monitoring instead of user actions.\\n\\n\";\n    markdown += \"**Note:** Synthetic Monitor data will only display if availability falls beneath the SLO target of \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"%.\\n\\n\";\n\n    if (syntheticSlosNeedingAttention.length > 0) {\n      for (const slo of syntheticSlosNeedingAttention) {\n        const config = slo.syntheticConfig;\n        const metrics = syntheticMetrics[config.syntheticId];\n\n        markdown += \"### \" + slo.name + \"\\n\\n\";\n\n        const syntheticUrl = buildSyntheticUrl(config.syntheticId, config.type);\n        const linkedMonitorName = syntheticUrl\n          ? \"[\" + config.syntheticName + \"](\" + syntheticUrl + \")\"\n          : config.syntheticName;\n        markdown += \"**Synthetic Monitor:** \" + linkedMonitorName + \"\\n\\n\";\n\n        markdown += \"| Metric | Value |\\n\";\n        markdown += \"|--------|-------|\\n\";\n        markdown += \"| **7-Day Avg Availability** | \" + fmtSyntheticAvailability(metrics.avgAvailability, SYNTHETIC_AVAILABILITY_THRESHOLD) + \" |\\n\";\n        markdown += \"| **SLO Target** | \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"% |\\n\";\n        markdown += \"| **Locations Monitored** | \" + metrics.locationCount + \" |\\n\";\n        markdown += \"\\n\";\n      }\n    } else {\n      markdown += \"\u2705 All Synthetic Monitors are meeting the availability target.\\n\\n\";\n    }\n  }\n\n  // ============================================\n  // LEGEND\n  // ============================================\n  markdown += \"---\\n\\n\";\n  markdown += \"## Legend\\n\\n\";\n  markdown += \"| Symbol | Meaning |\\n\";\n  markdown += \"|--------|----------|\\n\";\n  markdown += \"| \u2705 | Meeting target / No errors |\\n\";\n  markdown += \"| \u26a0\ufe0f | Warning / Low errors (1-10) / Slow (>3s) |\\n\";\n  markdown += \"| \u274c | Below target / High errors (>10) / Very slow (>12s) |\\n\";\n  markdown += \"| \u2796 | No data available |\\n\";\n  markdown += \"| \ud83d\udcc8 | Consistently improving (all windows trending up) |\\n\";\n  markdown += \"| \ud83d\udcc9 | Consistently degrading (all windows trending down) |\\n\";\n  markdown += \"| \u27a1\ufe0f | Stable (no meaningful change across windows) |\\n\";\n  markdown += \"| \u3030\ufe0f | Fluctuating (mixed up/down movement across windows) |\\n\";\n  markdown += \"\\n\";\n\n  markdown += \"---\\n\\n\";\n  markdown += \"[View Dashboard in Dynatrace](\" + sloData.dashboardUrl + \")\\n\";\n\n  console.log(\"=== MARKDOWN OUTPUT ===\");\n  console.log(markdown.substring(0, 500) + \"...\");\n\n  return {\n    markdown: markdown,\n    reportDate: sloData.reportDate\n  };\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": -1,
        "y": 3
      },
      "conditions": {
        "custom": "{{ result('fetch_slo_data').hasBreach == true }}",
        "states": {
          "build_markdown_email": "OK"
        }
      },
      "description": "Run custom JavaScript code.",
      "predecessors": [
        "build_markdown_email"
      ]
    },
    "build_markdown_email": {
      "name": "build_markdown_email",
      "input": {
        "script": "// ============================================\n// 2_build_markdown_email.js\n// SLO Email Report Builder - Markdown Generator\n//\n// This task transforms raw SLO data into a formatted\n// markdown email report with trend analysis, user action\n// metrics, and optional synthetic monitoring details.\n//\n// Prerequisites: Must run after fetch_slo_data task\n// ============================================\n\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nexport default async function ({ execution_id }) {\n  const ex = await execution(execution_id);\n  const sloData = await ex.result('fetch_slo_data');\n\n  console.log(\"=== BUILD MARKDOWN EMAIL ===\");\n  console.log(\"Number of SLOs received: \" + sloData.slos.length);\n  console.log(\"User action metrics received: \" + Object.keys(sloData.userActionMetrics || {}).length);\n  console.log(\"User action entities received: \" + Object.keys(sloData.userActionEntities || {}).length);\n  console.log(\"Synthetic metrics received: \" + Object.keys(sloData.syntheticMetrics || {}).length);\n\n  // ============================================\n  // CONFIGURATION\n  // TODO: Update these values for your domain\n  // ============================================\n\n  // TODO: Update report title and subtitle\n  const reportTitle = \"\ud83d\udcca SLO Report\";\n  const reportSubtitle = \"Your Domain Name (Prod)\"; // e.g., \"Financial Picture (Prod)\", \"Collaboration (Prod)\"\n\n  // TODO: Update dashboard URLs for your environment\n  const sloExplainedUrl = \"https://YOUR_TENANT.apps.dynatrace.com/ui/apps/dynatrace.classic.dashboards/#dashboard;gtf=-1w;gf=all;id=YOUR_DASHBOARD_ID\";\n  const errorAnalysisUrl = \"\"; // Optional: URL to an error analysis dashboard\n\n  // TODO: Update your Dynatrace tenant URL (used for deep links)\n  const dynatraceTenantUrl = \"https://YOUR_TENANT.apps.dynatrace.com\";\n\n  // TODO: If you have priority SLOs that should appear at the top of each category, list their IDs here\n  // These are typically application-level SLOs (e.g., Application Apdex, Error-Free Rate)\n  // Leave empty [] if you don't need priority ordering\n  const prioritySloIds = [\n    // \"your-priority-slo-id-1\", // e.g., Application Apdex\n    // \"your-priority-slo-id-2\", // e.g., All User Action Error-Free Rate\n  ];\n\n  // Synthetic availability threshold (only show if below this)\n  // TODO: Adjust if your synthetic SLOs have different targets\n  const SYNTHETIC_AVAILABILITY_THRESHOLD = 99.98;\n\n  // ============================================\n  // HELPER FUNCTIONS\n  // These generally don't need modification\n  // ============================================\n\n  // Helper to safely get nested property\n  const safeGet = (obj, prop) => obj && obj[prop] !== undefined ? obj[prop] : null;\n\n  // Helper to check if status is valid\n  const isValidStatus = (val) => val != null && val !== undefined && val >= 0;\n\n  // Helper to format status value\n  const fmtStatus = (val) => {\n    if (!isValidStatus(val)) return \"N/A\";\n    return val.toFixed(2) + \"%\";\n  };\n\n  // Helper to get status emoji based on value vs target\n  const getStatusEmoji = (val, target) => {\n    if (!isValidStatus(val)) return \"\u2796\";\n    if (val >= target) return \"\u2705\";\n    if (val >= target * 0.95) return \"\u26a0\ufe0f\";\n    return \"\u274c\";\n  };\n\n  // Helper to get the \"current\" period data\n  const getCurrent = (slo) => {\n    if (slo.current) return slo.current;\n    if (slo.daily) return slo.daily;\n    return { status: null, errorBudget: null };\n  };\n\n  // ============================================\n  // TREND CALCULATION\n  // Evaluates direction across all 4 time windows:\n  //   90d \u2192 30d \u2192 7d \u2192 current\n  //\n  // \ud83d\udcc8 = ALL transitions going up (consistently improving)\n  // \ud83d\udcc9 = ALL transitions going down (consistently degrading)\n  // \u27a1\ufe0f = ALL values stable (within threshold, no meaningful movement)\n  // \u3030\ufe0f = Mixed directions (fluctuating)\n  // ============================================\n  const getTrend = (slo) => {\n    const current = getCurrent(slo);\n    const values = [\n      safeGet(slo.day90, 'status'),\n      safeGet(slo.day30, 'status'),\n      safeGet(slo.day7, 'status'),\n      safeGet(current, 'status')\n    ];\n\n    // Filter to only valid values\n    const valid = values.filter(v => isValidStatus(v));\n\n    // Need at least 2 data points to determine a trend\n    if (valid.length < 2) return \"\u2796\";\n\n    // Threshold for considering two values \"the same\"\n    // Near-zero: only floating-point rounding is ignored\n    // Any real movement (even 0.01%) counts as directional\n    const STABLE_THRESHOLD = 0.005;\n\n    let ups = 0;\n    let downs = 0;\n    let flats = 0;\n\n    for (let i = 0; i < valid.length - 1; i++) {\n      const diff = valid[i + 1] - valid[i];\n\n      if (Math.abs(diff) <= STABLE_THRESHOLD) {\n        flats++;\n      } else if (diff > 0) {\n        ups++;\n      } else {\n        downs++;\n      }\n    }\n\n    const transitions = valid.length - 1;\n\n    // ALL transitions are flat = stable\n    if (flats === transitions) return \"\u27a1\ufe0f\";\n\n    // ALL non-flat transitions go up (flats are ok alongside ups)\n    if (downs === 0 && ups > 0) return \"\ud83d\udcc8\";\n\n    // ALL non-flat transitions go down (flats are ok alongside downs)\n    if (ups === 0 && downs > 0) return \"\ud83d\udcc9\";\n\n    // Mix of ups and downs = fluctuating\n    return \"\u3030\ufe0f\";\n  };\n\n  // Helper to format duration with emoji warning\n  const fmtDurationWithEmoji = (ms) => {\n    if (ms == null || ms === undefined) return \"N/A\";\n\n    let formatted;\n    if (ms < 1000) {\n      formatted = Math.round(ms) + \" ms\";\n    } else {\n      formatted = (ms / 1000).toFixed(2) + \" s\";\n    }\n\n    if (ms > 12000) {\n      return formatted + \" \u274c\";\n    } else if (ms > 3000) {\n      return formatted + \" \u26a0\ufe0f\";\n    }\n\n    return formatted;\n  };\n\n  // Helper to get error emoji based on count\n  const getErrorEmoji = (count) => {\n    if (count == null || count === 0) return \"\";\n    if (count <= 10) return \" \u26a0\ufe0f\";\n    return \" \u274c\";\n  };\n\n  // ============================================\n  // USER ACTION NAME SHORTENING\n  // TODO: Adjust the shortening logic if your user action\n  // names follow a different pattern than the default\n  // \"click [button] landing on https://...\" format\n  // ============================================\n  const shortenUserAction = (userAction) => {\n    if (!userAction) return \"N/A\";\n\n    let actionType = \"\";\n    let endpoint = \"\";\n\n    if (userAction.includes(\" landing on \")) {\n      const parts = userAction.split(\" landing on \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else if (userAction.includes(\" of page \")) {\n      const parts = userAction.split(\" of page \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else {\n      return userAction.length > 50 ? userAction.substring(0, 47) + \"...\" : userAction;\n    }\n\n    let path = endpoint.replace(/https?:\\/\\/[^\\/]+/, \"\");\n    const segments = path.split(\"/\").filter(s => s.length > 0);\n    if (segments.length > 2) {\n      endpoint = \".../\" + segments.slice(-2).join(\"/\");\n    } else if (segments.length > 0) {\n      endpoint = \".../\" + segments.join(\"/\");\n    } else {\n      endpoint = path;\n    }\n\n    return actionType + \" \u2192 \" + endpoint;\n  };\n\n  // Helper to build Dynatrace user action URL\n  const buildUserActionUrl = (userAction, entities) => {\n    if (!entities || !entities.entityId || !entities.applicationId) {\n      return null;\n    }\n\n    const encodedName = userAction\n      .replace(/ /g, '%20')\n      .replace(/:/g, ':')\n      .replace(/\\/\\//g, '%5C0%5C0')\n      .replace(/\\//g, '%5C0');\n\n    // TODO: Update the base URL to match your Dynatrace tenant\n    const baseUrl = dynatraceTenantUrl + \"/ui/apps/dynatrace.classic.frontend/#uemapplications/uemuseractionmetrics\";\n\n    return baseUrl +\n      \";uemuserActionId=\" + entities.entityId +\n      \";uaname=\" + encodedName +\n      \";uemapplicationId=\" + entities.applicationId +\n      \";gtf=-7d;gf=all\";\n  };\n\n  // Helper to build Dynatrace synthetic monitor URL\n  const buildSyntheticUrl = (syntheticId, type) => {\n    if (!syntheticId) return null;\n\n    // TODO: Update the base URL to match your Dynatrace tenant\n    const baseUrl = dynatraceTenantUrl + \"/ui/apps/dynatrace.classic.synthetic/ui\";\n\n    let monitorPath;\n    if (type === \"BROWSER\") {\n      monitorPath = \"browser-monitor\";\n    } else if (type === \"HTTP\") {\n      monitorPath = \"http-monitor\";\n    } else {\n      monitorPath = \"browser-monitor\"; // default\n    }\n\n    return baseUrl + \"/\" + monitorPath + \"/\" + syntheticId + \"?gtf=-7d&gf=all\";\n  };\n\n  // Helper to check if a user action needs attention\n  // TODO: Adjust thresholds if needed\n  //   - totalErrors >= 10: flags user actions with 10+ combined errors\n  //   - avgDuration >= 3000: flags user actions averaging 3+ seconds\n  const needsAttention = (metrics) => {\n    if (!metrics) return false;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDuration = metrics.avgDuration || 0;\n\n    return totalErrors >= 10 || avgDuration >= 3000;\n  };\n\n  // Helper to calculate attention score for ranking\n  const getAttentionScore = (metrics) => {\n    if (!metrics) return 0;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDurationSeconds = (metrics.avgDuration || 0) / 1000;\n\n    return (totalErrors * 10) + avgDurationSeconds;\n  };\n\n  // Helper to format synthetic availability with emoji\n  const fmtSyntheticAvailability = (availability, target) => {\n    if (availability == null) return \"N/A\";\n\n    const formatted = availability.toFixed(2) + \"%\";\n\n    if (availability >= target) {\n      return \"\u2705 \" + formatted;\n    } else if (availability >= target * 0.99) {\n      return \"\u26a0\ufe0f \" + formatted;\n    } else {\n      return \"\u274c \" + formatted;\n    }\n  };\n\n  // ============================================\n  // SORT HELPER: Priority SLOs first, then alphabetical\n  // Only applies if prioritySloIds is configured above\n  // ============================================\n  const sortWithPriority = (slos) => {\n    if (prioritySloIds.length === 0) return slos.sort((a, b) => a.name.localeCompare(b.name));\n\n    return slos.sort((a, b) => {\n      const aIsPriority = prioritySloIds.includes(a.id);\n      const bIsPriority = prioritySloIds.includes(b.id);\n\n      if (aIsPriority && !bIsPriority) return -1;\n      if (!aIsPriority && bIsPriority) return 1;\n\n      if (aIsPriority && bIsPriority) {\n        return prioritySloIds.indexOf(a.id) - prioritySloIds.indexOf(b.id);\n      }\n\n      return a.name.localeCompare(b.name);\n    });\n  };\n\n  // ============================================\n  // CATEGORIZE SLOs\n  // Pass/fail is based on the 7-day value\n  // This provides more stable alerting than daily fluctuations\n  // ============================================\n  const failingSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return isValidStatus(status) && status < slo.target;\n    })\n  );\n\n  const passingSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return isValidStatus(status) && status >= slo.target;\n    })\n  );\n\n  const noDataSLOs = sortWithPriority(\n    sloData.slos.filter(slo => {\n      const status = safeGet(slo.day7, \"status\");\n      return !isValidStatus(status);\n    })\n  );\n\n  console.log(\"Categorized: \" + failingSLOs.length + \" failing, \" + passingSLOs.length + \" passing, \" + noDataSLOs.length + \" no data\");\n\n  const breachStatus = failingSLOs.length > 0 ? \"\u274c BREACH\" : \"\u2705 OK\";\n\n  let markdown = \"\";\n\n  // ============================================\n  // REPORT HEADER\n  // ============================================\n  markdown += \"# \" + reportTitle + \"\\n\\n\";\n  markdown += \"## \" + reportSubtitle + \"\\n\\n\";\n  markdown += \"**Report Date:** \" + sloData.reportDate + \"\\n\\n\";\n\n  markdown += \"View SLO details and contributing factors on [dashboard](\" + sloData.dashboardUrl + \")\\n\\n\";\n  markdown += \"[SLOs explained](\" + sloExplainedUrl + \")\\n\\n\";\n\n  // ============================================\n  // EXECUTIVE SUMMARY\n  // ============================================\n  markdown += \"---\\n\\n\";\n  markdown += \"## Executive Summary\\n\\n\";\n  markdown += \"| Metric | Value |\\n\";\n  markdown += \"|--------|-------|\\n\";\n  markdown += \"| **Overall Status** | \" + breachStatus + \" |\\n\";\n  markdown += \"| Total SLOs Monitored | \" + sloData.slos.length + \" |\\n\";\n  markdown += \"| Passing | \" + passingSLOs.length + \" \u2705 |\\n\";\n  markdown += \"| Failing | \" + failingSLOs.length + (failingSLOs.length > 0 ? \" \u274c\" : \"\") + \" |\\n\";\n  markdown += \"| No Data | \" + noDataSLOs.length + (noDataSLOs.length > 0 ? \" \u2796\" : \"\") + \" |\\n\";\n  markdown += \"\\n\";\n\n  // ============================================\n  // SLO TABLE BUILDER\n  // Status emoji is based on the 7-day value\n  // Optional note appears between heading and table\n  // ============================================\n  const buildSLOTable = (slos, title, note) => {\n    if (slos.length === 0) return \"\";\n\n    let table = \"---\\n\\n\";\n    table += \"## \" + title + \"\\n\\n\";\n\n    // Optional note between heading and table\n    if (note) {\n      table += \"*\" + note + \"*\\n\\n\";\n    }\n\n    table += \"| SLO Name | Target | 90 Day | 30 Day | 7 Day | Current | Trend |\\n\";\n    table += \"|----------|--------|--------|--------|-------|---------|-------|\\n\";\n\n    for (const slo of slos) {\n      const current = getCurrent(slo);\n      const currentStatus = safeGet(current, \"status\");\n      const day7Status = safeGet(slo.day7, \"status\");\n\n      // Emoji reflects 7-day status vs target\n      const emoji = getStatusEmoji(day7Status, slo.target);\n      const trend = getTrend(slo);\n\n      table += \"| \" + emoji + \" \" + slo.name +\n        \" | \" + slo.target + \"%\" +\n        \" | \" + fmtStatus(safeGet(slo.day90, \"status\")) +\n        \" | \" + fmtStatus(safeGet(slo.day30, \"status\")) +\n        \" | \" + fmtStatus(day7Status) +\n        \" | \" + fmtStatus(currentStatus) +\n        \" | \" + trend +\n        \" |\\n\";\n    }\n\n    return table + \"\\n\";\n  };\n\n  // ============================================\n  // SLO TABLES\n  // ============================================\n  if (failingSLOs.length > 0) {\n    markdown += buildSLOTable(failingSLOs, \"\u274c SLOs Below Target (Action Required)\", \"Categorization is based on the 7-day value.\");\n  }\n\n  if (passingSLOs.length > 0) {\n    markdown += buildSLOTable(passingSLOs, \"\u2705 SLOs Meeting Target\");\n  }\n\n  if (noDataSLOs.length > 0) {\n    markdown += buildSLOTable(noDataSLOs, \"\u2796 SLOs With No Data\");\n  }\n\n  // ============================================\n  // USER ACTION METRICS SECTION\n  // Shows user actions that need attention:\n  //   - 10+ total errors across all error types\n  //   - 3+ second average duration\n  // Top 3 actions per SLO, ranked by severity score\n  // ============================================\n  const userActionMetrics = sloData.userActionMetrics || {};\n  const userActionEntities = sloData.userActionEntities || {};\n\n  const slosWithActionableUserActions = sloData.slos.filter(slo => {\n    // Skip synthetic SLOs - they don't have user actions\n    if (slo.isSynthetic) return false;\n    if (!slo.userAction || slo.userAction.length === 0) return false;\n\n    return slo.userAction.some(ua => {\n      const metrics = userActionMetrics[ua];\n      return metrics && needsAttention(metrics);\n    });\n  });\n\n  if (slosWithActionableUserActions.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83d\udcca User Action Metrics (7-Day Totals)\\n\\n\";\n\n    // TODO: Add error analysis dashboard link if available\n    if (errorAnalysisUrl) {\n      markdown += \"View detailed error analysis [dashboard](\" + errorAnalysisUrl + \").\\n\\n\";\n    }\n\n    markdown += \"The following user actions need attention (\u226510 total errors OR \u22653s avg duration).\\n\\n\";\n    markdown += \"**Note:** Click on the user action names to view them in Dynatrace. Metrics below are based on completed user sessions and combine all action types (XHR, Load, or Route Change) with the same name, which may result in different averages than the Dynatrace UI where these are displayed separately.\\n\\n\";\n\n    for (const slo of slosWithActionableUserActions) {\n      const userActions = Array.isArray(slo.userAction) ? slo.userAction : [slo.userAction];\n\n      const actionsNeedingAttention = userActions.filter(ua => {\n        const metrics = userActionMetrics[ua];\n        return metrics && needsAttention(metrics);\n      });\n\n      if (actionsNeedingAttention.length === 0) continue;\n\n      // Rank by severity score and show top 3\n      const sortedActions = actionsNeedingAttention\n        .map(ua => ({ userAction: ua, metrics: userActionMetrics[ua], score: getAttentionScore(userActionMetrics[ua]) }))\n        .sort((a, b) => b.score - a.score)\n        .slice(0, 3);\n\n      markdown += \"### \" + slo.name + \"\\n\\n\";\n\n      markdown += \"| User Action | Avg Duration | Custom Errors | JS Errors | Request Errors |\\n\";\n      markdown += \"|-------------|--------------|---------------|-----------|----------------|\\n\";\n\n      for (const item of sortedActions) {\n        const metrics = item.metrics;\n\n        const displayAction = shortenUserAction(item.userAction);\n        const entityData = userActionEntities[item.userAction];\n        const actionUrl = buildUserActionUrl(item.userAction, entityData);\n        const linkedAction = actionUrl ? \"[\" + displayAction + \"](\" + actionUrl + \")\" : displayAction;\n\n        const durationDisplay = fmtDurationWithEmoji(metrics.avgDuration);\n        const custDisplay = (metrics.customErrors || 0) + getErrorEmoji(metrics.customErrors);\n        const jsDisplay = (metrics.jsErrors || 0) + getErrorEmoji(metrics.jsErrors);\n        const reqDisplay = (metrics.requestErrors || 0) + getErrorEmoji(metrics.requestErrors);\n\n        markdown += \"| \" + linkedAction + \" | \" + durationDisplay + \" | \" + custDisplay + \" | \" + jsDisplay + \" | \" + reqDisplay + \" |\\n\";\n      }\n\n      markdown += \"\\n\";\n    }\n  }\n\n  // ============================================\n  // SYNTHETIC AVAILABILITY METRICS SECTION\n  // Only included if your workflow has synthetic SLOs\n  // If you don't use synthetic monitors, this section\n  // will be automatically skipped\n  // ============================================\n  const syntheticMetrics = sloData.syntheticMetrics || {};\n  const syntheticSlos = sloData.slos.filter(slo => slo.isSynthetic);\n\n  const syntheticSlosNeedingAttention = syntheticSlos.filter(slo => {\n    const config = slo.syntheticConfig;\n    if (!config) return false;\n\n    const metrics = syntheticMetrics[config.syntheticId];\n    if (!metrics || metrics.avgAvailability == null) return false;\n\n    return metrics.avgAvailability < SYNTHETIC_AVAILABILITY_THRESHOLD;\n  });\n\n  if (syntheticSlos.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83e\udd16 Synthetic Availability Metrics (7-Day Totals)\\n\\n\";\n    markdown += \"The following SLOs use Synthetic Monitoring instead of user actions.\\n\\n\";\n    markdown += \"**Note:** Synthetic Monitor data will only display if availability falls beneath the SLO target of \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"%.\\n\\n\";\n\n    if (syntheticSlosNeedingAttention.length > 0) {\n      for (const slo of syntheticSlosNeedingAttention) {\n        const config = slo.syntheticConfig;\n        const metrics = syntheticMetrics[config.syntheticId];\n\n        markdown += \"### \" + slo.name + \"\\n\\n\";\n\n        const syntheticUrl = buildSyntheticUrl(config.syntheticId, config.type);\n        const linkedMonitorName = syntheticUrl\n          ? \"[\" + config.syntheticName + \"](\" + syntheticUrl + \")\"\n          : config.syntheticName;\n        markdown += \"**Synthetic Monitor:** \" + linkedMonitorName + \"\\n\\n\";\n\n        markdown += \"| Metric | Value |\\n\";\n        markdown += \"|--------|-------|\\n\";\n        markdown += \"| **7-Day Avg Availability** | \" + fmtSyntheticAvailability(metrics.avgAvailability, SYNTHETIC_AVAILABILITY_THRESHOLD) + \" |\\n\";\n        markdown += \"| **SLO Target** | \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"% |\\n\";\n        markdown += \"| **Locations Monitored** | \" + metrics.locationCount + \" |\\n\";\n        markdown += \"\\n\";\n      }\n    } else {\n      markdown += \"\u2705 All Synthetic Monitors are meeting the availability target.\\n\\n\";\n    }\n  }\n\n  // ============================================\n  // LEGEND\n  // ============================================\n  markdown += \"---\\n\\n\";\n  markdown += \"## Legend\\n\\n\";\n  markdown += \"| Symbol | Meaning |\\n\";\n  markdown += \"|--------|----------|\\n\";\n  markdown += \"| \u2705 | Meeting target / No errors |\\n\";\n  markdown += \"| \u26a0\ufe0f | Warning / Low errors (1-10) / Slow (>3s) |\\n\";\n  markdown += \"| \u274c | Below target / High errors (>10) / Very slow (>12s) |\\n\";\n  markdown += \"| \u2796 | No data available |\\n\";\n  markdown += \"| \ud83d\udcc8 | Consistently improving (all windows trending up) |\\n\";\n  markdown += \"| \ud83d\udcc9 | Consistently degrading (all windows trending down) |\\n\";\n  markdown += \"| \u27a1\ufe0f | Stable (no meaningful change across windows) |\\n\";\n  markdown += \"| \u3030\ufe0f | Fluctuating (mixed up/down movement across windows) |\\n\";\n  markdown += \"\\n\";\n\n  markdown += \"---\\n\\n\";\n  markdown += \"[View Dashboard in Dynatrace](\" + sloData.dashboardUrl + \")\\n\";\n\n  console.log(\"=== MARKDOWN OUTPUT ===\");\n  console.log(markdown.substring(0, 500) + \"...\");\n\n  return {\n    markdown: markdown,\n    reportDate: sloData.reportDate\n  };\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "states": {
          "fetch_slo_data": "OK"
        }
      },
      "description": "Run custom JavaScript code.",
      "predecessors": [
        "fetch_slo_data"
      ]
    }
  }
}
