{
  "id": "889b61ba-32a1-40e7-b6f3-b649ce67217c",
  "title": "SLO Report - Template",
  "description": "",
  "actor": "b85f9ad1-dddd-4ad5-920d-ac7d4f6bd89f",
  "owner": "b85f9ad1-dddd-4ad5-920d-ac7d4f6bd89f",
  "ownerType": "USER",
  "isPrivate": true,
  "schemaVersion": 3,
  "trigger": {},
  "result": null,
  "type": "STANDARD",
  "input": {},
  "hourlyExecutionLimit": 1000,
  "guide": null,
  "tasks": {
    "send_email_1": {
      "name": "send_email_1",
      "input": {
        "cc": [],
        "to": [],
        "bcc": [],
        "content": "{{ result('build_markdown_email').markdown }}",
        "subject": "[EXT] SLO Report - Your Domain Name - {{ result('build_markdown_email').reportDate }}"
      },
      "action": "dynatrace.email:send-email",
      "position": {
        "x": 0,
        "y": 3
      },
      "conditions": {
        "states": {
          "build_markdown_email": "OK"
        }
      },
      "description": "Send email",
      "predecessors": [
        "build_markdown_email"
      ]
    },
    "fetch_slo_data": {
      "name": "fetch_slo_data",
      "input": {
        "script": "/**\n * ============================================================================\n * TASK 1: FETCH SLO DATA\n * ============================================================================\n * \n * PURPOSE:\n * This task fetches all raw data needed for the SLO report:\n *   - SLO status across multiple time periods (90-day, 30-day, 7-day, current)\n *   - User action performance metrics (duration, error counts)\n *   - Entity IDs for creating clickable deep links\n *   - Synthetic monitor availability data\n * \n * OUTPUT:\n * Returns a JSON object consumed by the build_markdown_email task\n * \n * PREREQUISITES:\n *   - SLOs must exist and be configured in Dynatrace\n *   - User actions should be marked as \"Key User Actions\" for deep linking\n *   - Synthetic monitors must be active (if using synthetic SLOs)\n * \n * ============================================================================\n */\n\nimport { serviceLevelObjectivesClient, monitoredEntitiesClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\nimport { rumUserSessionsClient } from \"@dynatrace-sdk/client-classic-environment-v1\";\nimport { metricsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\nexport default async function ({ execution_id }) {\n\n  // ============================================================================\n  // CONFIGURATION - MODIFY THIS SECTION FOR YOUR USE CASE\n  // ============================================================================\n\n  /**\n   * SLO IDs to monitor\n   * \n   * HOW TO FIND SLO IDs:\n   *   1. Open the SLO in Dynatrace\n   *   2. Look at the URL: https://your-tenant.apps.dynatrace.com/#slo;id=<SLO_ID>\n   *   3. Copy the ID portion\n   * \n   * Or use the API:\n   *   GET /api/v2/slo\n   */\n  const sloIds = [\n    // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    // \u2502 ADD YOUR SLO IDs HERE\n    // \u2502 Example: \"cc08364e-4037-3cc0-8a45-6b07288a1e1a\"\n    // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    \"your-slo-id-1\",  // TODO: Replace with actual SLO ID - Description of SLO\n    \"your-slo-id-2\",  // TODO: Replace with actual SLO ID - Description of SLO\n    // Add more SLO IDs as needed...\n  ];\n\n  /**\n   * Synthetic Monitor Configuration\n   * \n   * Use this for SLOs that are based on Synthetic Monitors rather than\n   * real user actions. These require special handling to fetch availability.\n   * \n   * HOW TO FIND SYNTHETIC IDs:\n   *   1. Open the synthetic monitor in Dynatrace\n   *   2. Look at the URL: https://...synthetic/ui/browser-monitor/<SYNTHETIC_ID>\n   *   3. Copy the SYNTHETIC_TEST-XXXX portion\n   * \n   * TYPE OPTIONS:\n   *   - \"BROWSER\" - For browser clickpath monitors\n   *   - \"HTTP\"    - For HTTP availability monitors\n   */\n  const syntheticSloConfig = {\n    // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    // \u2502 ADD SYNTHETIC SLO MAPPINGS HERE\n    // \u2502 Key = SLO ID (must also be in sloIds array above)\n    // \u2502 Value = Synthetic monitor details\n    // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    \n    // Example (uncomment and modify):\n    // \"your-synthetic-slo-id\": {\n    //   syntheticId: \"SYNTHETIC_TEST-XXXXXXXXXXXXXXXX\",\n    //   syntheticName: \"Your Monitor Name\",\n    //   type: \"BROWSER\"  // or \"HTTP\"\n    // },\n  };\n\n  /**\n   * Dashboard URL\n   * \n   * Link to the dashboard that provides detailed SLO information.\n   * This URL will be included in the email report for easy access.\n   * \n   * HOW TO FIND:\n   *   1. Open your dashboard in Dynatrace\n   *   2. Copy the full URL from the browser\n   */\n  const dashboardUrl = \"https://YOUR-TENANT.apps.dynatrace.com/ui/apps/dynatrace.classic.dashboards/#dashboard;gtf=-1w;gf=all;id=YOUR-DASHBOARD-ID\";\n  // TODO: Replace with your actual dashboard URL\n\n  // ============================================================================\n  // ADVANCED CONFIGURATION - MODIFY ONLY IF NEEDED\n  // ============================================================================\n\n  /**\n   * Dynatrace API Limits\n   * \n   * SLO_BATCH_SIZE: Max SLOs per API request (Dynatrace limit is 25)\n   * USQL_BATCH_SIZE: Max user actions per USQL query (keep small to avoid 414 errors)\n   */\n  const SLO_BATCH_SIZE = 25;\n  const USQL_BATCH_SIZE = 10;  // Reduce if you have very long user action names\n\n  /**\n   * Time Periods for Trend Analysis\n   * \n   * These periods are used to show SLO trends over time.\n   * Modify if you need different time windows.\n   */\n  const timePeriods = [\n    { name: \"day90\", from: \"now-90d\", to: \"now\" },\n    { name: \"day30\", from: \"now-30d\", to: \"now\" },\n    { name: \"day7\", from: \"now-7d\", to: \"now\" },\n    { name: \"current\", from: \"now-1d\", to: \"now\" }\n  ];\n\n  // ============================================================================\n  // HELPER FUNCTIONS - DO NOT MODIFY UNLESS NECESSARY\n  // ============================================================================\n\n  /**\n   * Splits an array into smaller batches\n   * Used to respect API limits\n   */\n  const batchArray = (array, batchSize) => {\n    const batches = [];\n    for (let i = 0; i < array.length; i += batchSize) {\n      batches.push(array.slice(i, i + batchSize));\n    }\n    return batches;\n  };\n\n  /**\n   * Extracts user action names from SLO filter expressions\n   * \n   * Supports these filter formats:\n   *   - entityname.in(\"action1\",\"action2\")\n   *   - entityname.equals(\"action\")\n   *   - entityname.contains(\"partial\")\n   */\n  const parseUserActionsFromFilter = (filter) => {\n    if (!filter) return [];\n\n    const normalizedFilter = filter.replace(/\\n/g, '').replace(/\\s+/g, ' ');\n    const userActions = [];\n\n    // Parse entityname.in(\"action1\",\"action2\",...)\n    const inMatch = normalizedFilter.match(/entityname\\.in\\s*\\(\\s*([^)]+)\\)/i);\n    if (inMatch) {\n      const quotedStrings = inMatch[1].match(/\"([^\"]+)\"/g);\n      if (quotedStrings) {\n        for (const qs of quotedStrings) {\n          const action = qs.replace(/^\"|\"$/g, '');\n          if (action && action.trim()) {\n            userActions.push(action.trim());\n          }\n        }\n      }\n    }\n\n    // Parse entityname.equals(\"action\")\n    const equalsMatch = normalizedFilter.match(/entityname\\.equals\\s*\\(\\s*\"([^\"]+)\"\\s*\\)/i);\n    if (equalsMatch) {\n      userActions.push(equalsMatch[1].trim());\n    }\n\n    // Parse entityname.contains(\"partial\")\n    const containsMatch = normalizedFilter.match(/entityname\\.contains\\s*\\(\\s*\"([^\"]+)\"\\s*\\)/i);\n    if (containsMatch) {\n      userActions.push(containsMatch[1].trim());\n    }\n\n    return userActions;\n  };\n\n  /**\n   * Checks if an SLO is synthetic-based\n   */\n  const isSyntheticSlo = (sloId) => {\n    return syntheticSloConfig.hasOwnProperty(sloId);\n  };\n\n  // ============================================================================\n  // MAIN EXECUTION - DO NOT MODIFY UNLESS NECESSARY\n  // ============================================================================\n\n  // Setup batching for SLO requests\n  const sloBatches = batchArray(sloIds, SLO_BATCH_SIZE);\n  console.log(\"Split \" + sloIds.length + \" SLOs into \" + sloBatches.length + \" batches\");\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 1: FETCH SLO STATUS DATA\n  // Queries each SLO across all time periods to build trend data\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const results = {};\n\n  for (const period of timePeriods) {\n    results[period.name] = [];\n\n    for (let batchIndex = 0; batchIndex < sloBatches.length; batchIndex++) {\n      const batch = sloBatches[batchIndex];\n      const batchSelector = 'id(\"' + batch.join('\",\"') + '\")';\n\n      try {\n        const data = await serviceLevelObjectivesClient.getSlo({\n          sloSelector: batchSelector,\n          timeFrame: \"GTF\",\n          from: period.from,\n          to: period.to,\n          pageSize: SLO_BATCH_SIZE,\n          evaluate: true\n        });\n\n        const batchResults = data.slo || [];\n        results[period.name] = results[period.name].concat(batchResults);\n\n        console.log(\"Fetched batch \" + (batchIndex + 1) + \"/\" + sloBatches.length + \" for \" + period.name + \": \" + batchResults.length + \" SLOs\");\n      } catch (error) {\n        console.error(\"Error fetching \" + period.name + \" batch \" + (batchIndex + 1) + \": \" + error.message);\n      }\n    }\n\n    console.log(\"Total \" + period.name + \": \" + results[period.name].length + \" SLOs\");\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 2: BUILD SLO REPORT STRUCTURE\n  // Combines data from all time periods into a unified report structure\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const sloReport = sloIds.map(id => {\n    const slo90 = results.day90.find(s => s.id === id);\n    const slo30 = results.day30.find(s => s.id === id);\n    const slo7 = results.day7.find(s => s.id === id);\n    const sloCurrent = results.current.find(s => s.id === id);\n\n    const baseSlo = sloCurrent || slo7 || slo30 || slo90;\n    const isSynthetic = isSyntheticSlo(id);\n    const userActions = isSynthetic ? [] : parseUserActionsFromFilter(baseSlo?.filter);\n    const syntheticConfig = isSynthetic ? syntheticSloConfig[id] : null;\n\n    return {\n      id: id,\n      name: baseSlo?.name || \"Unknown SLO\",\n      target: baseSlo?.target || 0,\n      filter: baseSlo?.filter || null,\n      userAction: userActions,\n      isSynthetic: isSynthetic,\n      syntheticConfig: syntheticConfig,\n      day90: { status: slo90?.evaluatedPercentage, errorBudget: slo90?.errorBudget },\n      day30: { status: slo30?.evaluatedPercentage, errorBudget: slo30?.errorBudget },\n      day7: { status: slo7?.evaluatedPercentage, errorBudget: slo7?.errorBudget },\n      current: { status: sloCurrent?.evaluatedPercentage, errorBudget: sloCurrent?.errorBudget }\n    };\n  });\n\n  console.log(\"Total SLOs processed: \" + sloReport.length);\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 3: FETCH USER ACTION METRICS\n  // Uses USQL to get performance data (duration, errors) for each user action\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const userActionNames = [...new Set(\n    sloReport\n      .filter(slo => !slo.isSynthetic)\n      .flatMap(slo => slo.userAction)\n      .filter(ua => ua !== null && ua !== undefined && ua.length > 0)\n  )];\n\n  console.log(\"Found \" + userActionNames.length + \" unique user actions across non-synthetic SLOs\");\n\n  let userActionMetrics = {};\n\n  if (userActionNames.length > 0) {\n    const now = Date.now();\n    const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);\n\n    const userActionBatches = batchArray(userActionNames, USQL_BATCH_SIZE);\n    console.log(\"Split \" + userActionNames.length + \" user actions into \" + userActionBatches.length + \" USQL batches\");\n\n    for (let batchIndex = 0; batchIndex < userActionBatches.length; batchIndex++) {\n      const batch = userActionBatches[batchIndex];\n\n      try {\n        const userActionList = batch.map(ua => \"'\" + ua.replace(/'/g, \"\\\\'\") + \"'\").join(',');\n\n        const usqlQuery = \"SELECT name, \" +\n          \"AVG(duration) AS avg_duration, \" +\n          \"SUM(customErrorCount) AS total_customErrors, \" +\n          \"SUM(javascriptErrorCount) AS total_jsErrors, \" +\n          \"SUM(requestErrorCount) AS total_requestErrors, \" +\n          \"COUNT(*) AS action_count \" +\n          \"FROM useraction \" +\n          \"WHERE name IN (\" + userActionList + \") \" +\n          \"GROUP BY name\";\n\n        console.log(\"USQL batch \" + (batchIndex + 1) + \"/\" + userActionBatches.length + \": querying \" + batch.length + \" user actions\");\n\n        const usqlData = await rumUserSessionsClient.getUsqlResultAsTable({\n          query: usqlQuery,\n          startTimestamp: sevenDaysAgo,\n          endTimestamp: now\n        });\n\n        if (usqlData && usqlData.values && usqlData.values.length > 0) {\n          const columns = usqlData.columnNames;\n          const getIndex = (name) => columns.indexOf(name);\n\n          for (const row of usqlData.values) {\n            const name = row[getIndex('name')];\n            userActionMetrics[name] = {\n              avgDuration: row[getIndex('avg_duration')],\n              customErrors: row[getIndex('total_customErrors')] || 0,\n              jsErrors: row[getIndex('total_jsErrors')] || 0,\n              requestErrors: row[getIndex('total_requestErrors')] || 0,\n              actionCount: row[getIndex('action_count')] || 0\n            };\n          }\n          console.log(\"  Retrieved metrics for \" + usqlData.values.length + \" user actions\");\n        } else {\n          console.log(\"  No data returned for batch \" + (batchIndex + 1));\n        }\n      } catch (error) {\n        console.error(\"USQL Error batch \" + (batchIndex + 1) + \": \" + error.message);\n      }\n    }\n\n    console.log(\"Total user action metrics: \" + Object.keys(userActionMetrics).length);\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 4: FETCH USER ACTION ENTITY IDs FOR DEEP LINKS\n  // Looks up APPLICATION_METHOD entity IDs to create clickable Dynatrace links\n  // \n  // NOTE: Only \"Key User Actions\" have entity IDs. If links aren't working,\n  //       mark the user action as a Key User Action in Dynatrace.\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  let userActionEntities = {};\n\n  if (userActionNames.length > 0) {\n    console.log(\"Fetching entity IDs for \" + userActionNames.length + \" user actions...\");\n\n    for (const userActionName of userActionNames) {\n      try {\n        const escapedName = userActionName.replace(/\"/g, '\\\\\"');\n        const entitySelector = 'type(\"APPLICATION_METHOD\"),entityName.equals(\"' + escapedName + '\")';\n\n        const response = await monitoredEntitiesClient.getEntities({\n          entitySelector: entitySelector,\n          from: \"now-7d\",\n          to: \"now\",\n          fields: \"+fromRelationships\"\n        });\n\n        if (response.entities && response.entities.length > 0) {\n          for (const entity of response.entities) {\n            const applicationId = entity.fromRelationships?.isApplicationMethodOf?.[0]?.id;\n\n            if (applicationId) {\n              userActionEntities[userActionName] = {\n                entityId: entity.entityId,\n                applicationId: applicationId\n              };\n              console.log(\"  Found: \" + userActionName.substring(0, 50) + \"... -> \" + entity.entityId);\n              break;\n            }\n          }\n        }\n      } catch (error) {\n        console.error(\"Error fetching entity for: \" + userActionName.substring(0, 50) + \"... - \" + error.message);\n      }\n    }\n\n    console.log(\"Entity mappings created: \" + Object.keys(userActionEntities).length);\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 5: FETCH SYNTHETIC MONITOR AVAILABILITY\n  // For synthetic-based SLOs, fetches 7-day availability metrics\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  let syntheticMetrics = {};\n\n  const syntheticSlos = sloReport.filter(slo => slo.isSynthetic);\n  console.log(\"Found \" + syntheticSlos.length + \" Synthetic SLOs\");\n\n  for (const slo of syntheticSlos) {\n    const config = slo.syntheticConfig;\n    if (!config) continue;\n\n    try {\n      const metricSelector = 'builtin:synthetic.browser.availability.location.total:filter(eq(\"dt.entity.synthetic_test\",\"' + config.syntheticId + '\")):avg';\n\n      console.log(\"Querying synthetic availability for: \" + config.syntheticName);\n\n      const response = await metricsClient.query({\n        metricSelector: metricSelector,\n        from: \"now-7d\",\n        to: \"now\",\n        resolution: \"Inf\",\n        acceptType: \"application/json; charset=utf-8\"\n      });\n\n      if (response.result && response.result.length > 0 && response.result[0].data) {\n        const dataPoints = response.result[0].data;\n\n        let totalAvailability = 0;\n        let locationCount = 0;\n        const locationDetails = [];\n\n        for (const dataPoint of dataPoints) {\n          const availability = dataPoint.values[0];\n          if (availability != null) {\n            totalAvailability += availability;\n            locationCount++;\n            locationDetails.push({\n              locationId: dataPoint.dimensionMap[\"dt.entity.geolocation\"] || \"Unknown\",\n              availability: availability\n            });\n          }\n        }\n\n        const avgAvailability = locationCount > 0 ? totalAvailability / locationCount : null;\n\n        syntheticMetrics[config.syntheticId] = {\n          syntheticName: config.syntheticName,\n          syntheticId: config.syntheticId,\n          type: config.type,\n          avgAvailability: avgAvailability,\n          locationCount: locationCount,\n          locationDetails: locationDetails\n        };\n\n        console.log(\"  \" + config.syntheticName + \" - Avg Availability: \" + (avgAvailability ? avgAvailability.toFixed(2) + \"%\" : \"N/A\"));\n      } else {\n        console.log(\"  No synthetic data returned for: \" + config.syntheticName);\n      }\n    } catch (error) {\n      console.error(\"Synthetic metrics error for \" + config.syntheticName + \": \" + error.message);\n    }\n  }\n\n  console.log(\"Total synthetic metrics: \" + Object.keys(syntheticMetrics).length);\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 6: PREPARE OUTPUT\n  // Bundles all data for the build_markdown_email task\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const reportDate = new Date().toISOString().split('T')[0];\n  \n  // Check if any SLO is breaching (used to trigger ADO ticket creation)\n  const hasBreach = sloReport.some(slo => {\n    const status = slo.current.status;\n    return status != null && status >= 0 && status < slo.target;\n  });\n\n  console.log(\"=== SUMMARY ===\");\n  console.log(\"Report Date: \" + reportDate);\n  console.log(\"Total SLOs: \" + sloReport.length);\n  console.log(\"User Actions with metrics: \" + Object.keys(userActionMetrics).length);\n  console.log(\"User Action Entities: \" + Object.keys(userActionEntities).length);\n  console.log(\"Synthetic monitors with metrics: \" + Object.keys(syntheticMetrics).length);\n  console.log(\"Has Breach: \" + hasBreach);\n\n  return {\n    reportDate: reportDate,\n    slos: sloReport,\n    userActionMetrics: userActionMetrics,\n    userActionEntities: userActionEntities,\n    syntheticMetrics: syntheticMetrics,\n    hasBreach: hasBreach,\n    dashboardUrl: dashboardUrl\n  };\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 1
      },
      "description": "Run custom JavaScript code.",
      "predecessors": []
    },
    "create_ado_ticket": {
      "name": "create_ado_ticket",
      "input": {
        "script": "/**\n * ============================================================================\n * TASK 4: CREATE ADO TICKET (OPTIONAL)\n * ============================================================================\n * \n * PURPOSE:\n * Automatically creates an Azure DevOps work item when SLOs breach their targets.\n * This enables automated incident tracking and team notification.\n * \n * EXECUTION:\n * This task should be configured with a CONDITIONAL execution:\n *   {{ result('fetch_slo_data').hasBreach == true }}\n * \n * This ensures tickets are only created when there's an actual breach.\n * \n * PREREQUISITES:\n *   1. Azure DevOps PAT with \"Work Items: Read & Write\" scope\n *   2. PAT stored in Dynatrace Credential Vault\n *   3. dev.azure.com added to Dynatrace Allowed Outbound Connections\n *   4. User account has permissions on the target Area Path in Azure\n * \n * ============================================================================\n */\n\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { credentialVaultClient } from '@dynatrace-sdk/client-classic-environment-v2';\n\nexport default async function ({ execution_id }) {\n  \n  // ============================================================================\n  // CONFIGURATION - MODIFY THIS SECTION FOR YOUR USE CASE\n  // ============================================================================\n\n  /**\n   * Azure DevOps Organization and Project\n   * \n   * HOW TO FIND:\n   *   Your ADO URL looks like: https://dev.azure.com/{organization}/{project}\n   */\n  const adoOrganization = \"YourOrganization\";  // TODO: Replace with your ADO organization\n  const adoProject = \"YourProject\";             // TODO: Replace with your ADO project\n\n  /**\n   * Area Path for Work Items\n   * \n   * This determines where the work item appears in ADO.\n   * Use backslashes to separate path segments.\n   * \n   * HOW TO FIND:\n   *   1. In ADO, go to Project Settings > Boards > Project Configuration\n   *   2. Navigate to Areas tab\n   *   3. Copy the full path\n   * \n   * PERMISSIONS REQUIRED:\n   *   The PAT user must have \"Edit work items in this node\" permission on this area path.\n   */\n  const areaPath = \"YourProject\\\\Team\\\\SubArea\";  // TODO: Replace with your area path\n  // Example: \"WealthManagement\\\\Core Wealth\\\\PrivatePassport\\\\P2-Deployables\"\n\n  /**\n   * Work Item Type\n   * \n   * Options: \"Bug\", \"User Story\", \"Task\", \"Feature\", \"Epic\", \"Issue\"\n   * Must match exactly what's configured in your ADO process template.\n   */\n  const workItemType = \"User Story\";  // TODO: Change if needed\n\n  /**\n   * Credential Vault ID\n   * \n   * The ID of the credential storing your Azure DevOps PAT.\n   * \n   * HOW TO SET UP:\n   *   1. Create a PAT in Azure DevOps with \"Work Items: Read & Write\" scope\n   *   2. In Dynatrace, go to Settings > Credential Vault\n   *   3. Add new credential:\n   *      - Type: Token\n   *      - Token: Your PAT value\n   *      - Scope: APP_ENGINE (required for workflows)\n   *   4. Copy the credential ID (CREDENTIALS_VAULT-XXXX)\n   */\n  const credentialVaultId = \"CREDENTIALS_VAULT-XXXXXXXXXXXXXXXX\";  // TODO: Replace with your credential ID\n\n  /**\n   * Tags (optional)\n   * \n   * Tags to add to the work item for filtering/searching in ADO.\n   * Separate multiple tags with semicolons.\n   */\n  const workItemTags = \"SLO-Alert;Auto-Generated;Dynatrace\";  // TODO: Customize tags\n\n  /**\n   * Report Domain Name\n   * \n   * Used in the work item title and description for identification.\n   */\n  const domainName = \"Your Domain\";  // TODO: Replace with your domain name (e.g., \"Settings & Authentication\")\n\n  // ============================================================================\n  // MAIN EXECUTION - MODIFY ONLY IF YOU NEED DIFFERENT WORK ITEM CONTENT\n  // ============================================================================\n\n  console.log(\"=== CREATE ADO TICKET ===\");\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 1: RETRIEVE DATA FROM PREVIOUS TASK\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const ex = await execution(execution_id);\n  const sloData = await ex.result('fetch_slo_data');\n\n  console.log(\"SLO Data received, hasBreach: \" + sloData.hasBreach);\n\n  // Double-check breach status (belt and suspenders with the conditional)\n  if (!sloData.hasBreach) {\n    console.log(\"No breach detected, skipping ticket creation\");\n    return { \n      status: \"skipped\", \n      reason: \"No SLO breach detected\" \n    };\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 2: RETRIEVE PAT FROM CREDENTIAL VAULT\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  console.log(\"Retrieving PAT from Credential Vault...\");\n\n  let pat;\n  try {\n    const credential = await credentialVaultClient.getCredentialsDetails({\n      id: credentialVaultId\n    });\n\n    pat = credential.token;\n\n    if (!pat) {\n      throw new Error(\"PAT token is empty or undefined\");\n    }\n\n    console.log(\"PAT retrieved successfully\");\n  } catch (error) {\n    console.error(\"Failed to retrieve PAT: \" + error.message);\n    return {\n      status: \"error\",\n      reason: \"Failed to retrieve credentials: \" + error.message\n    };\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 3: BUILD WORK ITEM CONTENT\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  // Identify failing SLOs\n  const failingSlos = sloData.slos.filter(slo => {\n    const status = slo.current?.status;\n    return status != null && status >= 0 && status < slo.target;\n  });\n\n  console.log(\"Found \" + failingSlos.length + \" failing SLOs\");\n\n  // Build descriptive title\n  const reportDate = sloData.reportDate;\n  const sloNames = failingSlos.map(s => s.name).join(\", \");\n  const title = \"[SLO Breach] \" + domainName + \" - \" + reportDate + \" - \" + sloNames.substring(0, 100);\n\n  // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // \u2502 BUILD WORK ITEM DESCRIPTION (HTML FORMAT)\n  // \u2502 Modify this section to change what appears in the work item\n  // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  let description = \"<h2>SLO Breach Alert</h2>\";\n  description += \"<p><strong>Report Date:</strong> \" + reportDate + \"</p>\";\n  description += \"<p><strong>Domain:</strong> \" + domainName + \"</p>\";\n  description += \"<p><strong>Dashboard:</strong> <a href=\\\"\" + sloData.dashboardUrl + \"\\\">View in Dynatrace</a></p>\";\n  \n  description += \"<h3>Failing SLOs</h3>\";\n  description += \"<table border=\\\"1\\\" cellpadding=\\\"5\\\" cellspacing=\\\"0\\\">\";\n  description += \"<tr><th>SLO Name</th><th>Target</th><th>Current</th><th>Gap</th></tr>\";\n\n  for (const slo of failingSlos) {\n    const currentStatus = slo.current?.status;\n    const gap = currentStatus != null ? (slo.target - currentStatus).toFixed(2) : \"N/A\";\n    \n    description += \"<tr>\";\n    description += \"<td>\" + slo.name + \"</td>\";\n    description += \"<td>\" + slo.target + \"%</td>\";\n    description += \"<td>\" + (currentStatus != null ? currentStatus.toFixed(2) + \"%\" : \"N/A\") + \"</td>\";\n    description += \"<td style=\\\"color: red;\\\">-\" + gap + \"%</td>\";\n    description += \"</tr>\";\n  }\n\n  description += \"</table>\";\n\n  description += \"<h3>Recommended Actions</h3>\";\n  description += \"<ol>\";\n  description += \"<li>Review the <a href=\\\"\" + sloData.dashboardUrl + \"\\\">SLO Dashboard</a> for details</li>\";\n  description += \"<li>Check user action metrics for performance issues</li>\";\n  description += \"<li>Investigate recent deployments or changes</li>\";\n  description += \"<li>Coordinate with the development team for remediation</li>\";\n  description += \"</ol>\";\n\n  description += \"<hr/>\";\n  description += \"<p><em>This work item was automatically generated by Dynatrace Workflows.</em></p>\";\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // STEP 4: CREATE WORK ITEM VIA ADO REST API\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n  // Encode work item type for URL (spaces become %20)\n  const encodedWorkItemType = encodeURIComponent(workItemType);\n  \n  // Build API URL\n  const adoUrl = \"https://dev.azure.com/\" + adoOrganization + \"/\" + adoProject + \n                 \"/_apis/wit/workitems/$\" + encodedWorkItemType + \"?api-version=7.1\";\n\n  console.log(\"ADO API URL: \" + adoUrl);\n\n  // Build JSON Patch document (ADO work item format)\n  const patchDocument = [\n    {\n      op: \"add\",\n      path: \"/fields/System.Title\",\n      value: title\n    },\n    {\n      op: \"add\",\n      path: \"/fields/System.Description\",\n      value: description\n    },\n    {\n      op: \"add\",\n      path: \"/fields/System.AreaPath\",\n      value: areaPath\n    },\n    {\n      op: \"add\",\n      path: \"/fields/System.Tags\",\n      value: workItemTags\n    }\n  ];\n\n  // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // \u2502 OPTIONAL: ADD ADDITIONAL FIELDS\n  // \u2502 Uncomment and modify to set other work item fields\n  // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  \n  // Assign to a specific user:\n  // patchDocument.push({\n  //   op: \"add\",\n  //   path: \"/fields/System.AssignedTo\",\n  //   value: \"user@company.com\"\n  // });\n\n  // Set iteration path:\n  // patchDocument.push({\n  //   op: \"add\",\n  //   path: \"/fields/System.IterationPath\",\n  //   value: \"YourProject\\\\Sprint 1\"\n  // });\n\n  // Set priority (1-4, where 1 is highest):\n  // patchDocument.push({\n  //   op: \"add\",\n  //   path: \"/fields/Microsoft.VSTS.Common.Priority\",\n  //   value: 2\n  // });\n\n  // Create Authorization header (Basic auth with empty username)\n  const authHeader = \"Basic \" + btoa(\":\" + pat);\n\n  console.log(\"Creating work item...\");\n\n  try {\n    const response = await fetch(adoUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json-patch+json\",\n        \"Authorization\": authHeader\n      },\n      body: JSON.stringify(patchDocument)\n    });\n\n    const responseText = await response.text();\n\n    if (!response.ok) {\n      console.error(\"ADO API Error: \" + response.status + \" - \" + responseText);\n      \n      // Provide helpful error messages\n      if (response.status === 401) {\n        return {\n          status: \"error\",\n          reason: \"Authentication failed. Check that your PAT is valid and not expired.\"\n        };\n      } else if (response.status === 403) {\n        return {\n          status: \"error\",\n          reason: \"Permission denied. Ensure your user account has 'Edit work items in this node' permission on the area path: \" + areaPath\n        };\n      } else if (response.status === 400) {\n        return {\n          status: \"error\",\n          reason: \"Bad request. Check area path and work item type. Details: \" + responseText\n        };\n      }\n      \n      return {\n        status: \"error\",\n        reason: \"ADO API returned \" + response.status + \": \" + responseText\n      };\n    }\n\n    const result = JSON.parse(responseText);\n    \n    console.log(\"Work item created successfully!\");\n    console.log(\"Work Item ID: \" + result.id);\n    console.log(\"Work Item URL: \" + result._links?.html?.href);\n\n    return {\n      status: \"success\",\n      workItemId: result.id,\n      workItemUrl: result._links?.html?.href || \"https://dev.azure.com/\" + adoOrganization + \"/\" + adoProject + \"/_workitems/edit/\" + result.id,\n      title: title,\n      failingSloCount: failingSlos.length\n    };\n\n  } catch (error) {\n    console.error(\"Failed to create work item: \" + error.message);\n    return {\n      status: \"error\",\n      reason: \"Request failed: \" + error.message\n    };\n  }\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": -1,
        "y": 3
      },
      "conditions": {
        "custom": "{{ result('fetch_slo_data').hasBreach == true }}",
        "states": {
          "build_markdown_email": "OK"
        }
      },
      "description": "Run custom JavaScript code.",
      "predecessors": [
        "build_markdown_email"
      ]
    },
    "build_markdown_email": {
      "name": "build_markdown_email",
      "input": {
        "script": "/**\n * ============================================================================\n * TASK 2: BUILD MARKDOWN EMAIL\n * ============================================================================\n * \n * PURPOSE:\n * Transforms raw SLO data into a formatted markdown email report.\n * \n * INPUT:\n * Receives data from fetch_slo_data task via execution context\n * \n * OUTPUT:\n * Returns markdown string and report date for the email task\n * \n * FEATURES:\n *   - Categorizes SLOs (Passing, Failing, No Data)\n *   - Shows trends across time periods\n *   - Filters user actions to only show those needing attention\n *   - Creates clickable deep links to Dynatrace pages\n *   - Formats synthetic monitor availability\n * \n * ============================================================================\n */\n\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nexport default async function ({ execution_id }) {\n  // Retrieve data from the fetch_slo_data task\n  const ex = await execution(execution_id);\n  const sloData = await ex.result('fetch_slo_data');\n\n  console.log(\"=== BUILD MARKDOWN EMAIL ===\");\n  console.log(\"Number of SLOs received: \" + sloData.slos.length);\n  console.log(\"User action metrics received: \" + Object.keys(sloData.userActionMetrics || {}).length);\n  console.log(\"User action entities received: \" + Object.keys(sloData.userActionEntities || {}).length);\n  console.log(\"Synthetic metrics received: \" + Object.keys(sloData.syntheticMetrics || {}).length);\n\n  // ============================================================================\n  // CONFIGURATION - MODIFY THIS SECTION FOR YOUR USE CASE\n  // ============================================================================\n\n  /**\n   * Report Title and Branding\n   * Customize these for your organization and domain\n   */\n  const REPORT_TITLE = \"\ud83c\udfe6 Your Organization - SLO Report\";  // TODO: Update organization name\n  const REPORT_SUBTITLE = \"Your Domain Name (PPC)\";          // TODO: Update domain name\n\n  /**\n   * Dashboard URLs\n   * Links included in the email for easy access to Dynatrace\n   */\n  const sloExplainedUrl = \"https://YOUR-TENANT.apps.dynatrace.com/ui/apps/dynatrace.classic.dashboards/#dashboard;gtf=-1w;gf=all;id=YOUR-DASHBOARD-ID\";\n  // TODO: Replace with your \"SLOs Explained\" dashboard URL (or remove if not needed)\n\n  /**\n   * Dynatrace Tenant Base URL\n   * Used for building deep links to user actions and synthetic monitors\n   */\n  const DYNATRACE_BASE_URL = \"https://YOUR-TENANT.apps.dynatrace.com\";\n  // TODO: Replace with your Dynatrace tenant URL\n\n  /**\n   * Thresholds for Filtering\n   * Only items exceeding these thresholds will be shown in the report\n   */\n  const SYNTHETIC_AVAILABILITY_THRESHOLD = 99.98;  // Show synthetic if below this %\n  const ERROR_THRESHOLD = 10;                       // Show user action if errors >= this\n  const DURATION_THRESHOLD_MS = 3000;               // Show user action if duration >= this (milliseconds)\n\n  /**\n   * Duration Warning Thresholds (for emoji indicators)\n   */\n  const DURATION_WARNING_MS = 3000;   // \u26a0\ufe0f Warning threshold\n  const DURATION_CRITICAL_MS = 12000; // \u274c Critical threshold\n\n  /**\n   * Error Warning Thresholds (for emoji indicators)\n   */\n  const ERROR_WARNING = 10;   // \u26a0\ufe0f Warning threshold\n  const ERROR_CRITICAL = 10;  // \u274c Critical threshold (same as warning = any errors are critical)\n\n  /**\n   * Maximum user actions to show per SLO\n   */\n  const MAX_USER_ACTIONS_PER_SLO = 3;\n\n  // ============================================================================\n  // HELPER FUNCTIONS - MODIFY IF YOU NEED DIFFERENT FORMATTING\n  // ============================================================================\n\n  /** Safely get nested property */\n  const safeGet = (obj, prop) => obj && obj[prop] !== undefined ? obj[prop] : null;\n\n  /** Check if status value is valid */\n  const isValidStatus = (val) => val != null && val !== undefined && val >= 0;\n\n  /** Format percentage status */\n  const fmtStatus = (val) => {\n    if (!isValidStatus(val)) return \"N/A\";\n    return val.toFixed(2) + \"%\";\n  };\n\n  /** Get status emoji based on value vs target */\n  const getStatusEmoji = (val, target) => {\n    if (!isValidStatus(val)) return \"\u2796\";\n    if (val >= target) return \"\u2705\";\n    if (val >= target * 0.95) return \"\u26a0\ufe0f\";  // Within 5% of target\n    return \"\u274c\";\n  };\n\n  /** Get trend indicator comparing current to 7-day */\n  const getTrend = (day7Val, currentVal) => {\n    if (!isValidStatus(day7Val) || !isValidStatus(currentVal)) return \"\";\n    const diff = currentVal - day7Val;\n    if (diff > 1) return \"\ud83d\udcc8\";   // Improving by more than 1%\n    if (diff < -1) return \"\ud83d\udcc9\";  // Degrading by more than 1%\n    return \"\u27a1\ufe0f\";                 // Stable\n  };\n\n  /** Get the \"current\" period data with fallback */\n  const getCurrent = (slo) => {\n    if (slo.current) return slo.current;\n    if (slo.daily) return slo.daily;\n    return { status: null, errorBudget: null };\n  };\n\n  /** Format duration with emoji warning */\n  const fmtDurationWithEmoji = (ms) => {\n    if (ms == null || ms === undefined) return \"N/A\";\n\n    let formatted;\n    if (ms < 1000) {\n      formatted = Math.round(ms) + \" ms\";\n    } else {\n      formatted = (ms / 1000).toFixed(2) + \" s\";\n    }\n\n    if (ms > DURATION_CRITICAL_MS) {\n      return formatted + \" \u274c\";\n    } else if (ms > DURATION_WARNING_MS) {\n      return formatted + \" \u26a0\ufe0f\";\n    }\n\n    return formatted;\n  };\n\n  /** Get error emoji based on count */\n  const getErrorEmoji = (count) => {\n    if (count == null || count === 0) return \"\";\n    if (count <= ERROR_WARNING) return \" \u26a0\ufe0f\";\n    return \" \u274c\";\n  };\n\n  /**\n   * Shorten user action name for display\n   * Extracts action type and endpoint, truncates long paths\n   */\n  const shortenUserAction = (userAction) => {\n    if (!userAction) return \"N/A\";\n\n    let actionType = \"\";\n    let endpoint = \"\";\n\n    if (userAction.includes(\" landing on \")) {\n      const parts = userAction.split(\" landing on \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else if (userAction.includes(\" of page \")) {\n      const parts = userAction.split(\" of page \");\n      actionType = parts[0];\n      endpoint = parts[1] || \"\";\n    } else {\n      return userAction.length > 50 ? userAction.substring(0, 47) + \"...\" : userAction;\n    }\n\n    // Extract just the path, remove domain\n    let path = endpoint.replace(/https?:\\/\\/[^\\/]+/, \"\");\n    const segments = path.split(\"/\").filter(s => s.length > 0);\n    if (segments.length > 2) {\n      endpoint = \".../\" + segments.slice(-2).join(\"/\");\n    } else if (segments.length > 0) {\n      endpoint = \".../\" + segments.join(\"/\");\n    } else {\n      endpoint = path;\n    }\n\n    return actionType + \" \u2192 \" + endpoint;\n  };\n\n  /**\n   * Build Dynatrace user action deep link URL\n   * \n   * NOTE: Only works for Key User Actions (those with entity IDs)\n   */\n  const buildUserActionUrl = (userAction, entities) => {\n    if (!entities || !entities.entityId || !entities.applicationId) {\n      return null;\n    }\n\n    const encodedName = userAction\n      .replace(/ /g, '%20')\n      .replace(/:/g, ':')\n      .replace(/\\/\\//g, '%5C0%5C0')\n      .replace(/\\//g, '%5C0');\n\n    const baseUrl = DYNATRACE_BASE_URL + \"/ui/apps/dynatrace.classic.frontend/#uemapplications/uemuseractionmetrics\";\n\n    return baseUrl +\n      \";uemuserActionId=\" + entities.entityId +\n      \";uaname=\" + encodedName +\n      \";uemapplicationId=\" + entities.applicationId +\n      \";gtf=-7d;gf=all\";\n  };\n\n  /**\n   * Build Dynatrace synthetic monitor deep link URL\n   */\n  const buildSyntheticUrl = (syntheticId, type) => {\n    if (!syntheticId) return null;\n\n    const baseUrl = DYNATRACE_BASE_URL + \"/ui/apps/dynatrace.classic.synthetic/ui\";\n\n    // Determine monitor type path\n    let monitorPath;\n    if (type === \"BROWSER\") {\n      monitorPath = \"browser-monitor\";\n    } else if (type === \"HTTP\") {\n      monitorPath = \"http-monitor\";\n    } else {\n      monitorPath = \"browser-monitor\"; // default\n    }\n\n    return baseUrl + \"/\" + monitorPath + \"/\" + syntheticId + \"?gtf=-7d&gf=all\";\n  };\n\n  /**\n   * Check if a user action needs attention based on thresholds\n   * Modify the conditions here to change what's shown in the report\n   */\n  const needsAttention = (metrics) => {\n    if (!metrics) return false;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDuration = metrics.avgDuration || 0;\n\n    // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    // \u2502 MODIFY THESE CONDITIONS TO CHANGE FILTERING LOGIC\n    // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    return totalErrors >= ERROR_THRESHOLD || avgDuration >= DURATION_THRESHOLD_MS;\n  };\n\n  /**\n   * Calculate attention score for ranking user actions by severity\n   * Higher score = more severe = shown first\n   */\n  const getAttentionScore = (metrics) => {\n    if (!metrics) return 0;\n\n    const totalErrors = (metrics.customErrors || 0) + (metrics.jsErrors || 0) + (metrics.requestErrors || 0);\n    const avgDurationSeconds = (metrics.avgDuration || 0) / 1000;\n\n    // \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    // \u2502 MODIFY THIS FORMULA TO CHANGE HOW ISSUES ARE PRIORITIZED\n    // \u2502 Current: Errors weighted 10x, duration in seconds added\n    // \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n    return (totalErrors * 10) + avgDurationSeconds;\n  };\n\n  /** Format synthetic availability with emoji */\n  const fmtSyntheticAvailability = (availability, target) => {\n    if (availability == null) return \"N/A\";\n\n    const formatted = availability.toFixed(2) + \"%\";\n\n    if (availability >= target) {\n      return \"\u2705 \" + formatted;\n    } else if (availability >= target * 0.99) {\n      return \"\u26a0\ufe0f \" + formatted;\n    } else {\n      return \"\u274c \" + formatted;\n    }\n  };\n\n  // ============================================================================\n  // CATEGORIZE SLOs\n  // ============================================================================\n  const failingSLOs = sloData.slos.filter(slo => {\n    const current = getCurrent(slo);\n    const status = safeGet(current, \"status\");\n    return isValidStatus(status) && status < slo.target;\n  });\n\n  const passingSLOs = sloData.slos.filter(slo => {\n    const current = getCurrent(slo);\n    const status = safeGet(current, \"status\");\n    return isValidStatus(status) && status >= slo.target;\n  });\n\n  const noDataSLOs = sloData.slos.filter(slo => {\n    const current = getCurrent(slo);\n    const status = safeGet(current, \"status\");\n    return !isValidStatus(status);\n  });\n\n  console.log(\"Categorized: \" + failingSLOs.length + \" failing, \" + passingSLOs.length + \" passing, \" + noDataSLOs.length + \" no data\");\n\n  const breachStatus = failingSLOs.length > 0 ? \"\u274c BREACH\" : \"\u2705 OK\";\n\n  // ============================================================================\n  // BUILD MARKDOWN REPORT\n  // ============================================================================\n  let markdown = \"\";\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // HEADER SECTION\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  markdown += \"# \" + REPORT_TITLE + \"\\n\\n\";\n  markdown += \"## \" + REPORT_SUBTITLE + \"\\n\\n\";\n  markdown += \"**Report Date:** \" + sloData.reportDate + \"\\n\\n\";\n\n  markdown += \"View SLO details and contributing factors on [dashboard](\" + sloData.dashboardUrl + \")\\n\\n\";\n  \n  // Optional: Add SLOs explained link (remove if not needed)\n  if (sloExplainedUrl && sloExplainedUrl.includes(\"YOUR-TENANT\") === false) {\n    markdown += \"[SLOs explained](\" + sloExplainedUrl + \")\\n\";\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // EXECUTIVE SUMMARY\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  markdown += \"---\\n\\n\";\n  markdown += \"## Executive Summary\\n\\n\";\n  markdown += \"| Metric | Value |\\n\";\n  markdown += \"|--------|-------|\\n\";\n  markdown += \"| **Overall Status** | \" + breachStatus + \" |\\n\";\n  markdown += \"| Total SLOs Monitored | \" + sloData.slos.length + \" |\\n\";\n  markdown += \"| Passing | \" + passingSLOs.length + \" \u2705 |\\n\";\n  markdown += \"| Failing | \" + failingSLOs.length + (failingSLOs.length > 0 ? \" \u274c\" : \"\") + \" |\\n\";\n  markdown += \"| No Data | \" + noDataSLOs.length + (noDataSLOs.length > 0 ? \" \u2796\" : \"\") + \" |\\n\";\n  markdown += \"\\n\";\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // SLO TABLE BUILDER\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const buildSLOTable = (slos, title) => {\n    if (slos.length === 0) return \"\";\n\n    let table = \"---\\n\\n\";\n    table += \"## \" + title + \"\\n\\n\";\n    table += \"| SLO Name | Target | 90 Day | 30 Day | 7 Day | Current | Trend |\\n\";\n    table += \"|----------|--------|--------|--------|-------|---------|-------|\\n\";\n\n    for (const slo of slos) {\n      const current = getCurrent(slo);\n      const currentStatus = safeGet(current, \"status\");\n      const day7Status = safeGet(slo.day7, \"status\");\n\n      const emoji = getStatusEmoji(currentStatus, slo.target);\n      const trend = getTrend(day7Status, currentStatus);\n\n      table += \"| \" + emoji + \" \" + slo.name + \" | \" + slo.target + \"% | \" + \n               fmtStatus(safeGet(slo.day90, \"status\")) + \" | \" + \n               fmtStatus(safeGet(slo.day30, \"status\")) + \" | \" + \n               fmtStatus(day7Status) + \" | \" + \n               fmtStatus(currentStatus) + \" | \" + trend + \" |\\n\";\n    }\n\n    return table + \"\\n\";\n  };\n\n  // Add SLO tables in order of priority\n  if (failingSLOs.length > 0) {\n    markdown += buildSLOTable(failingSLOs, \"\u274c SLOs Below Target (Action Required)\");\n  }\n\n  if (passingSLOs.length > 0) {\n    markdown += buildSLOTable(passingSLOs, \"\u2705 SLOs Meeting Target\");\n  }\n\n  if (noDataSLOs.length > 0) {\n    markdown += buildSLOTable(noDataSLOs, \"\u2796 SLOs With No Data\");\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // USER ACTION METRICS SECTION\n  // Shows only user actions that need attention\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const userActionMetrics = sloData.userActionMetrics || {};\n  const userActionEntities = sloData.userActionEntities || {};\n\n  const slosWithActionableUserActions = sloData.slos.filter(slo => {\n    if (slo.isSynthetic) return false;\n    if (!slo.userAction || slo.userAction.length === 0) return false;\n\n    return slo.userAction.some(ua => {\n      const metrics = userActionMetrics[ua];\n      return metrics && needsAttention(metrics);\n    });\n  });\n\n  if (slosWithActionableUserActions.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83d\udcca User Action Metrics (7-Day Totals)\\n\\n\";\n    markdown += \"The following user actions need attention (\u2265\" + ERROR_THRESHOLD + \" total errors OR \u2265\" + (DURATION_THRESHOLD_MS / 1000) + \"s avg duration).\\n\\n\";\n    markdown += \"**Note:** Click on the user action names to view them in Dynatrace. Metrics below are based on completed user sessions and combine all action types (XHR, Load, or Route Change) with the same name, which may result in different averages than the Dynatrace UI where these are displayed separately.\\n\\n\";\n\n    for (const slo of slosWithActionableUserActions) {\n      const userActions = Array.isArray(slo.userAction) ? slo.userAction : [slo.userAction];\n\n      const actionsNeedingAttention = userActions.filter(ua => {\n        const metrics = userActionMetrics[ua];\n        return metrics && needsAttention(metrics);\n      });\n\n      if (actionsNeedingAttention.length === 0) continue;\n\n      // Sort by severity and take top N\n      const sortedActions = actionsNeedingAttention\n        .map(ua => ({ userAction: ua, metrics: userActionMetrics[ua], score: getAttentionScore(userActionMetrics[ua]) }))\n        .sort((a, b) => b.score - a.score)\n        .slice(0, MAX_USER_ACTIONS_PER_SLO);\n\n      markdown += \"### \" + slo.name + \"\\n\\n\";\n\n      markdown += \"| User Action | Avg Duration | Custom Errors | JS Errors | Request Errors |\\n\";\n      markdown += \"|-------------|--------------|---------------|-----------|----------------|\\n\";\n\n      for (const item of sortedActions) {\n        const metrics = item.metrics;\n\n        const displayAction = shortenUserAction(item.userAction);\n        const entityData = userActionEntities[item.userAction];\n        const actionUrl = buildUserActionUrl(item.userAction, entityData);\n        const linkedAction = actionUrl ? \"[\" + displayAction + \"](\" + actionUrl + \")\" : displayAction;\n\n        const durationDisplay = fmtDurationWithEmoji(metrics.avgDuration);\n        const custDisplay = (metrics.customErrors || 0) + getErrorEmoji(metrics.customErrors);\n        const jsDisplay = (metrics.jsErrors || 0) + getErrorEmoji(metrics.jsErrors);\n        const reqDisplay = (metrics.requestErrors || 0) + getErrorEmoji(metrics.requestErrors);\n\n        markdown += \"| \" + linkedAction + \" | \" + durationDisplay + \" | \" + custDisplay + \" | \" + jsDisplay + \" | \" + reqDisplay + \" |\\n\";\n      }\n\n      markdown += \"\\n\";\n    }\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // SYNTHETIC AVAILABILITY METRICS SECTION\n  // Shows synthetic monitors below threshold\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  const syntheticMetrics = sloData.syntheticMetrics || {};\n  const syntheticSlos = sloData.slos.filter(slo => slo.isSynthetic);\n\n  const syntheticSlosNeedingAttention = syntheticSlos.filter(slo => {\n    const config = slo.syntheticConfig;\n    if (!config) return false;\n\n    const metrics = syntheticMetrics[config.syntheticId];\n    if (!metrics || metrics.avgAvailability == null) return false;\n\n    return metrics.avgAvailability < SYNTHETIC_AVAILABILITY_THRESHOLD;\n  });\n\n  if (syntheticSlos.length > 0) {\n    markdown += \"---\\n\\n\";\n    markdown += \"## \ud83e\udd16 Synthetic Availability Metrics (7-Day Totals)\\n\\n\";\n    markdown += \"The following SLOs use Synthetic Monitoring instead of user actions.\\n\\n\";\n    markdown += \"**Note:** Synthetic Monitor data will only display if availability falls beneath the SLO target of \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"%.\\n\\n\";\n\n    if (syntheticSlosNeedingAttention.length > 0) {\n      for (const slo of syntheticSlosNeedingAttention) {\n        const config = slo.syntheticConfig;\n        const metrics = syntheticMetrics[config.syntheticId];\n\n        markdown += \"### \" + slo.name + \"\\n\\n\";\n\n        // Build clickable link for synthetic monitor\n        const syntheticUrl = buildSyntheticUrl(config.syntheticId, config.type);\n        const linkedMonitorName = syntheticUrl\n          ? \"[\" + config.syntheticName + \"](\" + syntheticUrl + \")\"\n          : config.syntheticName;\n        markdown += \"**Synthetic Monitor:** \" + linkedMonitorName + \"\\n\\n\";\n\n        markdown += \"| Metric | Value |\\n\";\n        markdown += \"|--------|-------|\\n\";\n        markdown += \"| **7-Day Avg Availability** | \" + fmtSyntheticAvailability(metrics.avgAvailability, SYNTHETIC_AVAILABILITY_THRESHOLD) + \" |\\n\";\n        markdown += \"| **SLO Target** | \" + SYNTHETIC_AVAILABILITY_THRESHOLD + \"% |\\n\";\n        markdown += \"| **Locations Monitored** | \" + metrics.locationCount + \" |\\n\";\n        markdown += \"\\n\";\n      }\n    } else {\n      markdown += \"\u2705 All Synthetic Monitors are meeting the availability target.\\n\\n\";\n    }\n  }\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // LEGEND\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  markdown += \"---\\n\\n\";\n  markdown += \"## Legend\\n\\n\";\n  markdown += \"| Symbol | Meaning |\\n\";\n  markdown += \"|--------|----------|\\n\";\n  markdown += \"| \u2705 | Meeting target / No errors |\\n\";\n  markdown += \"| \u26a0\ufe0f | Warning / Low errors (1-\" + ERROR_WARNING + \") / Slow (>\" + (DURATION_WARNING_MS / 1000) + \"s) |\\n\";\n  markdown += \"| \u274c | Below target / High errors (>\" + ERROR_CRITICAL + \") / Very slow (>\" + (DURATION_CRITICAL_MS / 1000) + \"s) |\\n\";\n  markdown += \"| \u2796 | No data available |\\n\";\n  markdown += \"| \ud83d\udcc8 | Improving (current > 7 day) |\\n\";\n  markdown += \"| \ud83d\udcc9 | Degrading (current < 7 day) |\\n\";\n  markdown += \"| \u27a1\ufe0f | Stable |\\n\";\n  markdown += \"\\n\";\n\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  // FOOTER\n  // \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n  markdown += \"---\\n\\n\";\n  markdown += \"[View Dashboard in Dynatrace](\" + sloData.dashboardUrl + \")\\n\";\n\n  console.log(\"=== MARKDOWN OUTPUT ===\");\n  console.log(markdown.substring(0, 500) + \"...\");\n\n  return {\n    markdown: markdown,\n    reportDate: sloData.reportDate\n  };\n}\n"
      },
      "action": "dynatrace.automations:run-javascript",
      "position": {
        "x": 0,
        "y": 2
      },
      "conditions": {
        "states": {
          "fetch_slo_data": "OK"
        }
      },
      "description": "Run custom JavaScript code.",
      "predecessors": [
        "fetch_slo_data"
      ]
    }
  }
}